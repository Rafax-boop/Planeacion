@model Metas.AplicacionWeb.Models.ViewModels.VMDepartamentos
@{
    ViewData["Title"] = "Monitoreo";
}
<div class="mt-4 text-center">
    <h1 class="titulo fw-semibold">MONITOREO Y SEGUIMIENTO DE METAS</h1>
</div>
<div class="mt-5 pb-4 pt-3 rounded-5 glass-effect" style="padding-left: 20px; padding-right: 25px">
    <div class="row">
        <div class="col">
            <div class="mt-2 text-center">
                <label class="form-label fs-3 fw-bold titulo">Año Fiscal</label>
            </div>
        </div>
        <div class="col">
            <div class="mt-2 text-center">
                <label class="form-label fs-3 fw-bold titulo">Departamentos</label>
            </div>
        </div>
    </div>
    <div class="row g-1">
        <div class="col">
            <div class="col-12">
                <select class="titulo form-select input-arena" id="selectAnoFiscal">
                    @{
                        var anoActual = DateTime.Now.Year;
                        var anoMaximo = anoActual + 1;
                        var anoMinimo = anoActual - 5;

                        for (int ano = anoMaximo; ano >= anoMinimo; ano--)
                        {
                            <option value="@ano">@ano</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="col">
            <div class="col-12" style="margin-left: 6px">
                <select class="titulo form-select input-arena" id="selectDepartamento">
                    @if (User.IsInRole("Administrador"))
                    {
                        <option value="">-- Seleccione un departamento --</option>
                        @foreach (var act in Model.ListaDepartamentos)
                        {
                            <option value="@act.Value">@act.Text</option>
                        }
                    }
                    else
                    {
                        var departamentoUsuarioTexto = User.Claims.FirstOrDefault(c => c.Type == "Departamento")?.Value;

                        var departamentoUsuarioObjeto = Model.ListaDepartamentos
                        .FirstOrDefault(d => d.Text == departamentoUsuarioTexto);

                        if (departamentoUsuarioObjeto != null)
                        {
                            // Si se encuentra, usamos el Value (ID) y el Text (Nombre)
                            <option value="@departamentoUsuarioObjeto.Value">@departamentoUsuarioObjeto.Text</option>
                        }
                        else
                        {
                            // Opcional: Manejo si no se encuentra (solo mostrar el texto como fallback)
                            <option value="">Recargué la página</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div>
            <div class="mt-4 text-center">
                @if (User.IsInRole("Administrador"))
                {
                    <button class="boton-amarillo" type="button" id="btnNuevo">Agregar Nuevo</button>
                }
                <button class="boton-rojo" type="button" id="btnBuscar">Buscar</button>
            </div>
        </div>
    </div>
</div>

<div id="seccionResultados" class="mt-4 pb-4 pt-3 rounded-5 glass-effect" style="padding-left: 20px; padding-right: 25px; display: none;">
    <h2 class="fw-semibold text-start" id="ano">
        Ejercicio Fiscal
    </h2>
    <h3 class="fw-light" id="tituloDepartamento">
        Departamento:
    </h3>

    <div class="mt-3 mb-3 text-center">
        <button class="boton-amarillo"
                onclick="irATablero()"
                style="color: forestgreen; box-shadow: 0 5px 8px 0 forestgreen; border: 1px solid forestgreen !important; text-decoration: none; display: inline-block; padding: 8px 16px;">
            Tablero
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-borderless align-middle shadow-sm rounded-3 overflow-hidden" id="tablaDatos">
            <thead class="bg-danger text-white">
                <tr>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Pp</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Componente</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Actividad</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Descripción de la Actividad</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Programa o servicio de asistencia social</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Ene</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Feb</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Mar</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Abr</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">May</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Jun</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Jul</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Ago</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Sep</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Oct</th>
                    <th scope="col" class="text-center px-3 py-3 border-end border-light border-opacity-25">Nov</th>
                    <th scope="col" class="text-center px-3 py-3">Dic</th>
                </tr>
            </thead>
            <tbody id="tbodyDatos" class="bg-light bg-opacity-50">
                <!-- Los datos se cargarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>

    <!-- Mensaje de carga -->
    <div id="mensajeCarga" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando datos...</p>
    </div>

    <!-- Mensaje cuando no hay datos -->
    <div id="mensajeSinDatos" class="alert alert-info text-center" style="display: none;">
        No se encontraron datos para los criterios seleccionados.
    </div>
</div>    <!-- Mensaje de carga -->
<div id="mensajeCarga" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Cargando datos...</p>
</div>

<!-- Mensaje cuando no hay datos -->
<div id="mensajeSinDatos" class="alert alert-info text-center" style="display: none;">
    No se encontraron datos para los criterios seleccionados.
</div>

<div class="modal fade" id="modalModificarActividad" tabindex="-1" aria-labelledby="modalModificarActividadLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalModificarActividadLabel">Modificar Actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formModificarActividad">
                <div class="modal-body">

                    <input type="hidden" id="IdProcesoModal" name="IdProceso" />
                    <input type="hidden" id="modoFormulario" value="editar" /> <!-- Nuevo campo para identificar el modo -->
                    <!-- CAMPOS EXTRAS SOLO PARA AGREGAR NUEVO -->
                    <div id="camposNuevoRegistro" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="AnoFiscalModal" class="form-label">Año Fiscal</label>
                                <input type="number" class="form-control" id="AnoFiscalModal" name="AnoFiscal" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="DepartamentoModal" class="form-label">Departamento</label>
                                <input type="text" class="form-control" id="DepartamentoModal" name="Departamento" readonly>
                                <input type="hidden" id="IdDepartamentoModal" name="IdDepartamento">
                            </div>
                        </div>
                        <hr class="my-4">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="selectProgramaPresupuestario" class="form-label">Programa Presupuestario</label>
                            <select class="form-select" id="selectProgramaPresupuestario" name="PP">
                                <option value="3">Agenda</option>
                                <option value="1">E046</option>
                                <option value="2">E047</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="ComponenteModal" class="form-label">Componente</label>
                            <input type="number" class="form-control" id="ComponenteModal" name="Componente">
                        </div>
                        <div class="col-md-4">
                            <label for="ActividadModal" class="form-label">Actividad</label>
                            <input type="number" class="form-control" id="ActividadModal" name="Actividad">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="DescripcionActividadModal" class="form-label">Descripción de la actividad</label>
                        <textarea class="form-control" id="DescripcionActividadModal" name="DescripcionActividad" rows="3"></textarea>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md">
                            <label for="selectUnidadMedida" class="form-label">Unidad de Medida</label>
                            <select class="form-select" id="selectUnidadMedida" name="UnidadMedida">
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="ProgramaSocialModal" class="form-label">Programa o servicio de asistencia social</label>
                        <input type="text" class="form-control" id="ProgramaSocialModal" name="ProgramaSocial" maxlength="255">
                    </div>

                    <h5 class="mt-4 mb-2">Meta Programada</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center">
                            <thead class="bg-info text-white">
                                <tr><th>Enero</th><th>Febrero</th><th>Marzo</th><th>Abril</th><th>Mayo</th><th>Junio</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalEnero" id="TotalEnero" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalFebrero" id="TotalFebrero" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalMarzo" id="TotalMarzo" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalAbril" id="TotalAbril" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalMayo" id="TotalMayo" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalJunio" id="TotalJunio" value="0"></td>
                                </tr>
                            </tbody>
                            <thead class="bg-info text-white">
                                <tr><th>Julio</th><th>Agosto</th><th>Septiembre</th><th>Octubre</th><th>Noviembre</th><th>Diciembre</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalJulio" id="TotalJulio" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalAgosto" id="TotalAgosto" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalSeptiembre" id="TotalSeptiembre" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalOctubre" id="TotalOctubre" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalNoviembre" id="TotalNoviembre" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm meta-prog" name="TotalDiciembre" id="TotalDiciembre" value="0"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h5 class="mt-4 mb-2">Personas Programadas</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center">
                            <thead class="bg-success text-white">
                                <tr><th>Enero</th><th>Febrero</th><th>Marzo</th><th>Abril</th><th>Mayo</th><th>Junio</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="EneroPersona" id="TotalEneroPersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="FebreroPersona" id="TotalFebreroPersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="MarzoPersona" id="TotalMarzoPersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="AbrilPersona" id="TotalAbrilPersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="MayoPersona" id="TotalMayoPersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="JunioPersona" id="TotalJunioPersonas" value="0"></td>
                                </tr>
                            </tbody>
                            <thead class="bg-success text-white">
                                <tr><th>Julio</th><th>Agosto</th><th>Septiembre</th><th>Octubre</th><th>Noviembre</th><th>Diciembre</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="JulioPersona" id="TotalJulioPersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="AgostoPersona" id="TotalAgostoPersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="SeptiembrePersona" id="TotalSeptiembrePersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="OctubrePersona" id="TotalOctubrePersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="NoviembrePersona" id="TotalNoviembrePersonas" value="0"></td>
                                    <td><input type="number" class="form-control form-control-sm personas-prog" name="DiciembrePersona" id="TotalDiciembrePersonas" value="0"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardarModal">Guardar y continuar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const esAdmin = @(User.IsInRole("Administrador").ToString().ToLower())

        function irATablero() {
            var anoFiscal = $('#selectAnoFiscal').val();
            var departamento = $('#selectDepartamento').val();

            if (!anoFiscal || !departamento) {
                alert('Por favor, seleccione año fiscal y departamento primero');
                return;
            }

            // Redirigir a TableroControl con parámetros
            window.location.href = '@Url.Action("TableroControl", "Monitoreo")' +
                                  '?anoFiscal=' + anoFiscal +
                                  '&departamento=' + departamento;
        }

        function habilitarCaptura(element) {
            const idProceso = $(element).data('idproceso');
            const mesNumero = $(element).data('mes');

            if (confirm(`¿Está seguro de habilitar la fecha de captura?`)) {
                $.ajax({
                    url: '@Url.Action("HabilitarCaptura", "Monitoreo")',
                    type: 'POST',
                    data: {
                        idProceso: idProceso,
                        mes: mesNumero
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('Captura habilitada correctamente. La página se recargará.');
                            $('#btnBuscar').click();
                        } else {
                            alert('Error al habilitar la captura: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error de comunicación con el servidor.');
                        console.error('AJAX Error:', error);
                    }
                });
            }
        }

        function eliminarCapturaMes(elemento) {
                const idProceso = $(elemento).data('idproceso');
                const mes = $(elemento).data('mes');

                const nombresMeses = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

                if (confirm(`¿Está seguro de que desea eliminar la captura de ${nombresMeses[mes]}?\n\nEsta acción:\n- Eliminará todos los registros externos del mes\n- Marcará el mes como no capturado\n\nEsta acción no se puede deshacer.`)) {

                    $(elemento).removeClass('fa-trash').addClass('fa-spinner fa-spin');

                    $.ajax({
                        url: '@Url.Action("EliminarCapturaMes", "Monitoreo")',
                        type: 'POST',
                        data: {
                            idProceso: idProceso,
                            mes: mes
                        },
                        success: function(response) {
                            if (response.success) {
                                alert(response.mensaje);
                                $('#btnBuscar').click();
                            } else {
                                alert('Error: ' + response.mensaje);
                                $(elemento).removeClass('fa-spinner fa-spin').addClass('fa-trash');
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('Error al eliminar la captura del mes');
                            $(elemento).removeClass('fa-spinner fa-spin').addClass('fa-trash');
                        }
                    });
                }
            }

        function obtenerFechaHabilitacion(item, mesNumero) {
            // Las propiedades vienen en camelCase desde el JSON
            const nombresMesesCamel = {
                1: 'fechaEnero', 2: 'fechaFebrero', 3: 'fechaMarzo', 4: 'fechaAbril',
                5: 'fechaMayo', 6: 'fechaJunio', 7: 'fechaJulio', 8: 'fechaAgosto',
                9: 'fechaSeptiembre', 10: 'fechaOctubre', 11: 'fechaNoviembre', 12: 'fechaDiciembre'
            };

            const nombrePropiedad = nombresMesesCamel[mesNumero];
            return item[nombrePropiedad];
        }

        $(document).ready(function() {
            $('#btnBuscar').click(function() {
                var anoFiscal = $('#selectAnoFiscal').val();
                var departamento = $('#selectDepartamento').val();
                var departamentoTexto = $('#selectDepartamento option:selected').text();

                if (!departamento) {
                    alert('Por favor, seleccione un departamento');
                    return;
                }

                $('#seccionResultados').slideDown();
                $('#ano').text('Ejercicio Fiscal: ' + anoFiscal);
                $('#tituloDepartamento').text('Departamento: ' + departamentoTexto);
                $('#mensajeCarga').show();
                $('#tablaDatos').hide();
                $('#mensajeSinDatos').hide();

                $.ajax({
                    url: '@Url.Action("ObtenerDatos", "Monitoreo")',
                    type: 'GET',
                    data: {
                        anoFiscal: anoFiscal,
                        departamento: departamento
                    },
                    success: function(response) {
                        $('#mensajeCarga').hide();

                        if (response.success && response.datos && response.datos.length > 0) {
                            $('#tbodyDatos').empty();

                            var esAdmin = response.esAdmin;

                            $.each(response.datos, function(index, item) {
                                var prefijoActividad = '';
                                if (item.pp && item.pp.toLowerCase() === 'agenda') {
                                    prefijoActividad = 'T';
                                }

                                var actividadCompleta = prefijoActividad + (item.componente || '') + '.' + (item.actividad || '');

                                function generarIcono(valor, mesNumero, fechasCaptura, idProceso, item) {
                                    let iconoHTML = '';
                                    let claseIcono = '';
                                    let titulo = '';
                                    let color = '';

                                    const botonEliminarMes = esAdmin ?
                                        `<i
                                            class="fa-solid fa-trash"
                                            title="Eliminar Captura del Mes"
                                            data-idproceso="${idProceso}"
                                            data-mes="${mesNumero}"
                                            onclick="eliminarCapturaMes(this)"
                                            style="cursor: pointer; color: #dc3545;"></i>` : '';

                                    if (valor === 1 || valor === true) {
                                        color = 'text-success';
                                        claseIcono = 'fa-circle-check';
                                        titulo = 'Completado';
                                        const url = '@Url.Action("ActualizacionMeses", "Monitoreo")' + '?idProceso=' + idProceso + '&mes=' + mesNumero + '&modo=visualizar';
                                        iconoHTML = `<a href="${url}"><i class="fa-solid ${claseIcono} ${color}" title="${titulo}"></i></a>`;
                                        if (esAdmin) {
                                            iconoHTML += `<br>${botonEliminarMes}`;
                                        }
                                    } else {
                                        // Obtener la fecha habilitada manualmente
                                        const fechaHabilitadaMes = obtenerFechaHabilitacion(item, mesNumero);

                                        let estaHabilitadoManualmente = false;
                                        if (fechaHabilitadaMes) {
                                            const partes = fechaHabilitadaMes.split('-');
                                            const fechaHabilitada = new Date(partes[0], partes[1] - 1, partes[2]);
                                            const hoy = new Date();

                                            fechaHabilitada.setHours(0, 0, 0, 0);
                                            hoy.setHours(0, 0, 0, 0);

                                            estaHabilitadoManualmente = (fechaHabilitada.getTime() === hoy.getTime());
                                        }

                                        let enPeriodoCaptura = false;
                                        if (fechasCaptura && fechasCaptura[mesNumero]) {
                                            const fechaInicio = new Date(fechasCaptura[mesNumero].fechaInicio);
                                            const fechaFin = new Date(fechasCaptura[mesNumero].fechaFin);
                                            const hoy = new Date();

                                            hoy.setHours(0, 0, 0, 0);
                                            fechaInicio.setHours(0, 0, 0, 0);
                                            fechaFin.setHours(0, 0, 0, 0);

                                            enPeriodoCaptura = (hoy >= fechaInicio && hoy <= fechaFin);
                                        }

                                        if (enPeriodoCaptura || estaHabilitadoManualmente) {
                                            color = 'text-primary clickable-icon';
                                            claseIcono = 'fa-circle-xmark';

                                            if (estaHabilitadoManualmente && !enPeriodoCaptura) {
                                                titulo = 'Pendiente - Habilitado por administrador';
                                            } else {
                                                titulo = 'Pendiente - En periodo de captura';
                                            }

                                            const url = '@Url.Action("ActualizacionMeses", "Monitoreo")' + '?idProceso=' + idProceso + '&mes=' + mesNumero;
                                            iconoHTML = `<a href="${url}"><i class="fa-solid ${claseIcono} ${color}" title="${titulo}" style="cursor: pointer;"></i></a>`;

                                        } else {
                                            color = 'text-danger';
                                            claseIcono = 'fa-circle-xmark';
                                            titulo = 'Pendiente - Fuera de periodo';

                                            if (esAdmin) {
                                                const botonAdmin = `<i
                                                    class="fa-sharp fa-solid fa-check-to-slot"
                                                    title="Habilitar Captura (Admin)"
                                                    data-idproceso="${idProceso}"
                                                    data-mes="${mesNumero}"
                                                    onclick="habilitarCaptura(this)"
                                                    style="cursor: pointer; color: #C04116;"></i>`;

                                                iconoHTML = `<i class="fa-solid ${claseIcono} ${color}" title="${titulo}"></i><br>${botonAdmin}<br>${botonEliminarMes}`;
                                            } else {
                                                iconoHTML = `<i class="fa-solid ${claseIcono} ${color}" title="${titulo}"></i>`;
                                            }
                                        }
                                    }
                                    return iconoHTML;
                                }

                                var btnEliminar = '';
                                var btnEditar = '';

                                // Para ADMINISTRADOR
                                if (esAdmin) {
                                    btnEditar = '<button type="button" class="btn btn-primary btn-sm btn-editar me-1" data-id="' + item.idProceso + '"><i class="fa-solid fa-pen-to-square"></i></button>';
                                    btnEliminar = '<button type="button" class="btn btn-danger btn-sm btn-eliminar" data-id="' + item.idProceso + '"><i class="fa-solid fa-trash"></i></button>';
                                }

                                var fila = '<tr>' +
                                    '<td>' + item.pp + '<div class="mt-1">' + btnEditar + btnEliminar + '</div></td>' +
                                    '<td>' + item.componente + '</td>' +
                                    '<td>' + actividadCompleta + '</td>' +
                                    '<td>' + item.descripcionActividad + '</td>' +
                                    '<td>' + item.programaSocial + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.enero, 1, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.febrero, 2, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.marzo, 3, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.abril, 4, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.mayo, 5, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.junio, 6, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.julio, 7, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.agosto, 8, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.septiembre, 9, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.octubre, 10, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.noviembre, 11, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                    '<td class="text-center">' + generarIcono(item.diciembre, 12, item.fechasCaptura, item.idProceso, item) + '</td>' +
                                '</tr>';
                                $('#tbodyDatos').append(fila);
                            });

                            $('#tablaDatos').show();
                        } else {
                            $('#mensajeSinDatos').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#mensajeCarga').hide();
                        alert('Error al cargar los datos: ' + error);
                    }
                });
            });

            function limpiarFormularioModal() {
                $('#IdProcesoModal').val('');
                $('#selectProgramaPresupuestario').val('Agenda');
                $('#ComponenteModal').val('');
                $('#ActividadModal').val('');
                $('#DescripcionActividadModal').val('');
                $('#ProgramaSocialModal').val('');

                // Limpiar las metas programadas
                $('.meta-prog').val(0);
                $('.personas-prog').val(0);
            }

            $('#tbodyDatos').on('click', '.btn-eliminar', function() {
                var idProceso = $(this).data('id');

                if (confirm('¿Está seguro de que desea eliminar este registro? Esta acción es irreversible y eliminará datos en 4 tablas.')) {
                    $.ajax({
                        url: '@Url.Action("EliminarRegistro", "Programacion")',
                        type: 'POST',
                        data: { id: idProceso },
                        success: function(response) {
                            if (response.success) {
                                alert(response.mensaje);
                                // Recargar la tabla
                                $('#btnBuscar').click();
                            } else {
                                alert('Error: ' + response.mensaje);
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('Error en la comunicación con el servidor al intentar eliminar.');
                        }
                    });
                }
            });

            $('#btnNuevo').click(function() {
                var anoFiscal = $('#selectAnoFiscal').val();
                var departamento = $('#selectDepartamento').val();
                var departamentoTexto = $('#selectDepartamento option:selected').text();

                if (!departamento) {
                    alert('Por favor, seleccione un departamento antes de agregar un nuevo registro');
                    return;
                }

                // Configurar modal en modo "nuevo"
                $('#modoFormulario').val('nuevo');
                $('#modalModificarActividadLabel').text('Agregar Nueva Actividad');
                $('#btnGuardarModal').text('Guardar');

                // Mostrar campos extras
                $('#camposNuevoRegistro').show();

                // Limpiar todos los campos del formulario PRIMERO
                limpiarFormularioModal();

                // Llenar campos de año y departamento DESPUÉS de limpiar
                $('#AnoFiscalModal').val(anoFiscal);
                $('#DepartamentoModal').val(departamentoTexto);
                $('#IdDepartamentoModal').val(departamento);

                // Cargar las unidades de medida
                cargarUnidadesMedida();

                // Abrir el modal
                var modal = new bootstrap.Modal(document.getElementById('modalModificarActividad'));
                modal.show();
            });


            $('#tbodyDatos').on('click', '.btn-editar', function() {
                const idProceso = $(this).data('id');

                $.ajax({
                    url: '@Url.Action("ObtenerDatosEdicion", "Monitoreo")',
                    type: 'GET',
                    data: { idProceso: idProceso },
                    success: function(data) {
                        if (data) {
                            // Configurar modal en modo "editar"
                            $('#modoFormulario').val('editar');
                            $('#modalModificarActividadLabel').text('Modificar Actividad');
                            $('#btnGuardarModal').text('Guardar y continuar');

                            // Ocultar campos extras
                            $('#camposNuevoRegistro').hide();

                            // Rellenar el modal con los datos
                            llenarModalEdicion(data);

                            // Abrir el modal
                            var modal = new bootstrap.Modal(document.getElementById('modalModificarActividad'));
                            modal.show();
                        } else {
                            alert('Error: No se encontraron datos para el ID proporcionado.');
                        }
                    },
                    error: function() {
                        alert('Ocurrió un error al cargar los datos del registro.');
                    }
                });
            });

            function cargarUnidadesMedida() {
                $.ajax({
                    url: '@Url.Action("ObtenerUnidadesMedida", "Monitoreo")', // Deberás crear esta acción
                    type: 'GET',
                    success: function(data) {
                        const selectMedida = $('#selectUnidadMedida');
                        selectMedida.empty();

                        if (data && data.length > 0) {
                            data.forEach(function(medida) {
                                selectMedida.append(
                                    $('<option>', {
                                        value: medida.value,
                                        text: medida.text
                                    })
                                );
                            });
                        }
                    },
                    error: function() {
                        console.error('Error al cargar las unidades de medida');
                    }
                });
            }

            function llenarModalEdicion(data) {
                const selectMedida = $('#selectUnidadMedida');
                selectMedida.empty();

                const unidadMedidaActual = data.unidadMedida.toUpperCase();

                if (data.listaMedidas && data.listaMedidas.length > 0) {
                    data.listaMedidas.forEach(function(medida) {
                        selectMedida.append(
                            $('<option>', {
                                value: medida.value,
                                text: medida.text
                            })
                        );
                    });
                }

                // Campos principales
                $('#IdProcesoModal').val(data.idProceso);
                $('#selectProgramaPresupuestario').val(data.pp);
                $('#ComponenteModal').val(data.componente);
                $('#ActividadModal').val(data.actividad);
                $('#DescripcionActividadModal').val(data.descripcionActividad);
                selectMedida.val(unidadMedidaActual);
                $('#ProgramaSocialModal').val(data.programaSocial);

                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

                meses.forEach(mes => {
                    const campoMeta = $(`#Total${mes}`);
                    if (campoMeta.length) {
                        campoMeta.val(data[`total${mes}`] || 0);
                    }

                    const mesMinuscula = mes.charAt(0).toLowerCase() + mes.slice(1);
                    const campoPersonas = $(`#Total${mes}Personas`);
                    if (campoPersonas.length) {
                        campoPersonas.val(data[`${mesMinuscula}Persona`] || 0);
                    }
                });
            }

            $('#formModificarActividad').submit(function(e) {
                e.preventDefault();

                const modo = $('#modoFormulario').val();
                const formData = $(this).serialize();

                // DEBUG: Ver qué datos se están enviando
                // console.log('Modo:', modo);
                // console.log('Datos del formulario:', formData);

                let urlDestino;
                if (modo === 'nuevo') {
                    urlDestino = '@Url.Action("GuardarNuevo", "Monitoreo")';
                } else {
                    urlDestino = '@Url.Action("GuardarEdicion", "Monitoreo")';
                }

                $.ajax({
                    url: urlDestino,
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            var modal = bootstrap.Modal.getInstance(document.getElementById('modalModificarActividad'));
                            modal.hide();
                            $('#btnBuscar').click();
                        } else {
                            alert('Error al guardar: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error AJAX:', xhr.responseText);
                        alert('Error de conexión al intentar guardar.');
                    }
                });
            });
        });
    </script>
}