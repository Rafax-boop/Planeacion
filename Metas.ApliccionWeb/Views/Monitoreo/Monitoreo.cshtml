@model Metas.AplicacionWeb.Models.ViewModels.VMDepartamentos
@{
    ViewData["Title"] = "Monitoreo";
}
<div class="mt-5 pb-4 pt-3 rounded-5 glass-effect" style="padding-left: 20px; padding-right: 25px">
    <div class="row">
        <div class="col">
            <div class="mt-2 text-center">
                <label class="form-label fs-3 fw-bold titulo">Año Fiscal</label>
            </div>
        </div>
        <div class="col">
            <div class="mt-2 text-center">
                <label class="form-label fs-3 fw-bold titulo">Departamentos</label>
            </div>
        </div>
    </div>
    <div class="row g-1">
        <div class="col">
            <div class="col-12">
                <select class="titulo form-select input-arena" id="selectAnoFiscal">
                    @{
                        var anoActual = DateTime.Now.Year;
                        var anoMaximo = anoActual + 1;
                        var anoMinimo = anoActual - 5;

                        for (int ano = anoMaximo; ano >= anoMinimo; ano--)
                        {
                            <option value="@ano">@ano</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="col">
            <div class="col-12" style="margin-left: 6px">
                <select class="titulo form-select input-arena" id="selectDepartamento">
                    @if (User.IsInRole("Administrador"))
                    {
                        <option value="">-- Seleccione un departamento --</option>
                        @foreach (var act in Model.ListaDepartamentos)
                        {
                            <option value="@act.Value">@act.Text</option>
                        }
                    }
                    else
                    {
                        var departamentoUsuarioTexto = User.Claims.FirstOrDefault(c => c.Type == "Departamento")?.Value;

                        var departamentoUsuarioObjeto = Model.ListaDepartamentos
                        .FirstOrDefault(d => d.Text == departamentoUsuarioTexto);

                        if (departamentoUsuarioObjeto != null)
                        {
                            // Si se encuentra, usamos el Value (ID) y el Text (Nombre)
                            <option value="@departamentoUsuarioObjeto.Value">@departamentoUsuarioObjeto.Text</option>
                        }
                        else
                        {
                            // Opcional: Manejo si no se encuentra (solo mostrar el texto como fallback)
                            <option value="">Recargué la página</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div>
            <div class="mt-4 text-center">
                <button class="boton-rojo" type="button" id="btnBuscar">Buscar</button>
            </div>
        </div>
    </div>
</div>

<div id="seccionResultados" class="mt-4 pb-4 pt-3 rounded-5 glass-effect" style="padding-left: 20px; padding-right: 25px; display: none;">
    <h2 class="fw-semibold text-start">
        Ejercicio Fiscal
    </h2>
    <h3 class="fw-light" id="tituloDepartamento">
        Departamento:
    </h3>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="tablaDatos">
            <thead class="table-dark">
                <tr>
                    <th>Pp</th>
                    <th>Componente</th>
                    <th>Actividad</th>
                    <th>Descripción de la Actividad</th>
                    <th>Programa o servicio de asistencia social</th>
                    <th>Ene</th>
                    <th>Feb</th>
                    <th>Mar</th>
                    <th>Abr</th>
                    <th>May</th>
                    <th>Jun</th>
                    <th>Jul</th>
                    <th>Ago</th>
                    <th>Sep</th>
                    <th>Oct</th>
                    <th>Nov</th>
                    <th>Dic</th>                    
                </tr>
            </thead>
            <tbody id="tbodyDatos">
                <!-- Los datos se cargarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>

    <!-- Mensaje de carga -->
    <div id="mensajeCarga" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando datos...</p>
    </div>

    <!-- Mensaje cuando no hay datos -->
    <div id="mensajeSinDatos" class="alert alert-info text-center" style="display: none;">
        No se encontraron datos para los criterios seleccionados.
    </div>
</div>

@section Scripts{
    <script>
        $(document).ready(function() {
        // Evento click del botón Buscar
        $('#btnBuscar').click(function() {
            var anoFiscal = $('#selectAnoFiscal').val();
            var departamento = $('#selectDepartamento').val();

            // Validar que se haya seleccionado un departamento
            if (!departamento) {
                alert('Por favor, seleccione un departamento');
                return;
            }

            // Mostrar la sección de resultados
            $('#seccionResultados').slideDown();

            // Mostrar mensaje de carga
            $('#mensajeCarga').show();
            $('#tablaDatos').hide();
            $('#mensajeSinDatos').hide();

            // Llamada AJAX para obtener los datos
            $.ajax({
                url: '@Url.Action("ObtenerDatos", "Monitoreo")',
                type: 'GET',
                data: {
                    anoFiscal: anoFiscal,
                    departamento: departamento
                },
            success: function(response) {
                $('#mensajeCarga').hide();

                if (response.success && response.datos && response.datos.length > 0) {
                    $('#tbodyDatos').empty();

                    $.each(response.datos, function(index, item) {
                        var prefijoActividad = '';
                        if (item.pp && item.pp.toLowerCase() === 'agenda') {
                            prefijoActividad = 'T';
                        }

                        var actividadCompleta = prefijoActividad + (item.componente || '') + '.' + (item.actividad || '');

                        function generarIcono(valor, mesNumero, fechasCaptura, idProceso) { // <-- ¡Recibir idProceso!
                            let iconoHTML = '';
                            let claseIcono = '';
                            let titulo = '';
                            let color = '';

                            if (valor === 1 || valor === true) {
                                // Opción 1: Completado - Check verde (No redirige)
                                color = 'text-success';
                                claseIcono = 'fa-circle-check';
                                titulo = 'Completado';
                                iconoHTML = `<i class="fa-solid ${claseIcono} ${color}" title="${titulo}"></i>`;
                            } else {
                                // Opción 2: No completado - Verificar periodo de captura
                                if (fechasCaptura && fechasCaptura[mesNumero]) {
                                    // ... (Toda la lógica de fechas aquí) ...
                                    const fechaInicio = new Date(fechasCaptura[mesNumero].fechaInicio);
                                    const fechaFin = new Date(fechasCaptura[mesNumero].fechaFin);
                                    const hoy = new Date();

                                    hoy.setHours(0, 0, 0, 0);
                                    fechaInicio.setHours(0, 0, 0, 0);
                                    fechaFin.setHours(0, 0, 0, 0);

                                    if (hoy >= fechaInicio && hoy <= fechaFin) {
                                        // Opción 2.1: Pendiente - EN PERIODO DE CAPTURA (¡DEBE REDIRIGIR!)
                                        color = 'text-primary clickable-icon';
                                        claseIcono = 'fa-circle-xmark';
                                        titulo = 'Pendiente - En periodo de captura';

                                        // Genera el enlace de redirección a tu nueva vista
                                        // Asume que la vista se llama 'ActualizarMeses' en el controlador 'Monitoreo' o 'Programacion'
                                            const url = '@Url.Action("ActualizacionMeses", "Monitoreo")' + '?idProceso=' + idProceso + '&mes=' + mesNumero;

                                        // Usamos un <a> con el URL
                                        iconoHTML = `<a href="${url}"><i class="fa-solid ${claseIcono} ${color}" title="${titulo}" style="cursor: pointer;"></i></a>`;

                                    } else {
                                        // Opción 2.2: Pendiente - FUERA DE PERIODO (No redirige)
                                        color = 'text-danger';
                                        claseIcono = 'fa-circle-xmark';
                                        titulo = 'Pendiente - Fuera de periodo';
                                        iconoHTML = `<i class="fa-solid ${claseIcono} ${color}" title="${titulo}"></i>`;
                                    }
                                } else {
                                    // Opción 3: Sin datos de fechas
                                    color = 'text-danger';
                                    claseIcono = 'fa-circle-xmark';
                                    titulo = 'Pendiente - Fuera de periodo';
                                    iconoHTML = `<i class="fa-solid ${claseIcono} ${color}" title="${titulo}"></i>`;
                                }
                            }
                            return iconoHTML;
                        }

                        var fila = '<tr>' +
                            '<td>' + item.pp + '</td>' +
                            '<td>' + item.componente + '</td>' +
                            '<td>' + actividadCompleta + '</td>' +
                            '<td>' + item.descripcionActividad + '</td>' +
                            '<td>' + item.programaSocial + '</td>' +
                            '<td class="text-center">' + generarIcono(item.enero, 1, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.febrero, 2, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.marzo, 3, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.abril, 4, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.mayo, 5, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.junio, 6, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.julio, 7, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.agosto, 8, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.septiembre, 9, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.octubre, 10, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.noviembre, 11, item.fechasCaptura, item.idProceso) + '</td>' +
                            '<td class="text-center">' + generarIcono(item.diciembre, 12, item.fechasCaptura, item.idProceso) + '</td>' +
                        '</tr>';
                        $('#tbodyDatos').append(fila);
                    });

                    $('#tablaDatos').show();
                } else {
                    $('#mensajeSinDatos').show();
                }
            },
                error: function(xhr, status, error) {
                    $('#mensajeCarga').hide();
                    alert('Error al cargar los datos: ' + error);
                }
            });
        });
    })
    </script>
}