@{
    ViewData["Title"] = "Tablero de Control";
    int numeroRegistros = ViewBag.NumeroRegistros ?? 0;
    int anoFiscal = ViewBag.AnoFiscal ?? DateTime.Now.Year;
}

<div class="container-fluid mt-4">

    <!-- Encabezado -->
    <div class="glass-effect rounded-3 p-3 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="fw-bold titulo mb-1">TABLERO DE CONTROL</h2>
                <p class="mb-0 text-muted">Ejercicio Fiscal: @anoFiscal - Total de Actividades: @numeroRegistros</p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-controller="Monitoreo" asp-action="Monitoreo"
                   class="btn btn-outline-primary">
                    ← Volver al Monitoreo
                </a>
            </div>
        </div>
    </div>

    @if (numeroRegistros == 0)
    {
        <div class="alert alert-info text-center">
            <h5>No hay datos disponibles para mostrar</h5>
            <p>No se encontraron registros para los criterios seleccionados.</p>
        </div>
    }
    else
    {
        <div id="contenedor-tableros">
            <!-- Los tableros se generarán aquí automáticamente -->
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const numeroRegistros = @numeroRegistros;
            const contenedor = $('#contenedor-tableros');

            if (numeroRegistros > 0) {
                // Generar un tablero por cada registro
                for (let i = 1; i <= numeroRegistros; i++) {
                    const tableroHTML = crearTablero(i);
                    contenedor.append(tableroHTML);
                }

                // Aplicar colores después de generar todos los tableros
                setTimeout(aplicarColoresAutomaticos, 100);
            }
        });

        // Función para crear el HTML de un tablero individual
        function crearTablero(numeroTablero) {
            return `
            <div class="tablero-individual mb-5 border-bottom pb-4" data-tablero="${numeroTablero}">

                <!-- ENCABEZADO DE LA ACTIVIDAD -->
                <div class="glass-effect rounded-3 p-3 mb-3 bg-primary bg-opacity-10">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="fw-bold titulo mb-1">
                                Actividad ${numeroTablero}
                            </h4>
                            <p class="mb-1 text-muted">Descripción de la actividad ${numeroTablero}</p>
                            <small class="text-muted">Programa Social ${numeroTablero}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-info fs-6">Registro ${numeroTablero}</span>
                        </div>
                    </div>
                </div>

                <!-- INFORMACIÓN DEL PROGRAMA -->
                <div class="glass-effect rounded-3 p-3 mb-3">
                    <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">INFORMACIÓN DEL PROGRAMA</h5>
                    <div class="row small">
                        <div class="col-md-6 border-end pe-3">
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Componente:</span>
                                <span>Componente ${numeroTablero}</span>
                            </div>
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Número de Actividad:</span>
                                <span>${numeroTablero}.${numeroTablero}</span>
                            </div>
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Programa Social:</span>
                                <span>Programa Social ${numeroTablero}</span>
                            </div>
                        </div>
                        <div class="col-md-6 ps-3">
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Unidad de Medida:</span>
                                <span>Unidad ${numeroTablero}</span>
                            </div>
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Descripción:</span>
                                <span>Descripción completa de la actividad ${numeroTablero}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CALENDARIZACIÓN ANUAL -->
                <div class="glass-effect rounded-3 p-3 mb-3" style="background-color: white">
                    <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">CALENDARIZACIÓN ANUAL</h5>
                    <div class="row">
                        <!-- Programado -->
                        <div class="col-md-6 border-end pe-3">
                            <h6 class="fw-semibold text-primary mb-2">PROGRAMADO</h6>
                            <div class="table-responsive">
                                <table class="table table-sm text-center mb-2">
                                    <thead class="bg-primary text-white">
                                        <tr>
                                            <th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th>
                                            <th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>100</td><td>150</td><td>200</td><td>180</td><td>220</td><td>190</td>
                                            <td>210</td><td>230</td><td>240</td><td>250</td><td>260</td><td>270</td>
                                            <td class="fw-bold bg-info bg-opacity-10">2550</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Realizado -->
                        <div class="col-md-6 ps-3">
                            <h6 class="fw-semibold text-success mb-2">REALIZADO</h6>
                            <div class="table-responsive">
                                <table class="table table-sm text-center mb-2">
                                    <thead class="bg-success text-white">
                                        <tr>
                                            <th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th>
                                            <th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>115</td><td>142</td><td>196</td><td>183</td><td>187</td><td>167</td>
                                            <td>157</td><td>165</td><td>156</td><td>145</td><td>117</td><td>113</td>
                                            <td class="fw-bold bg-success bg-opacity-10">1843</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PORCENTAJE DE AVANCE MENSUAL -->
                <div class="glass-effect rounded-3 p-3 mb-3" style="background-color: white">
                    <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">AVANCE MENSUAL</h5>
                    <div class="table-responsive">
                        <table class="table table-sm text-center mb-1">
                            <thead class="bg-warning text-dark">
                                <tr>
                                    <th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th>
                                    <th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="ene">115%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="feb">95%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="mar">98%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="abr">102%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="may">85%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="jun">88%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="jul">75%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="ago">72%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="sep">65%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="oct">58%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="nov">45%</div></td>
                                    <td><div class="fw-bold porcentaje-mes" data-mes="dic">42%</div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PORCENTAJE TRIMESTRAL Y ANUAL -->
                <div class="glass-effect rounded-3 p-3" style="background-color: white">
                    <div class="row">
                        <!-- Porcentaje Trimestral -->
                        <div class="col-md-8 border-end pe-3">
                            <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">TRIMESTRAL</h5>
                            <div class="row text-center">
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">1ER</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="1">115%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-1" style="width: 100%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">2DO</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="2">95%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-2" style="width: 95%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">3ER</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="3">85%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-3" style="width: 85%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">4TO</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="4">65%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-4" style="width: 65%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Porcentaje Anual -->
                        <div class="col-md-4 ps-3">
                            <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">ANUAL</h5>
                            <div class="text-center">
                                <div class="h3 fw-bold porcentaje-anual">85%</div>
                                <div class="progress mb-2" style="height: 12px;">
                                    <div class="progress-bar progress-anual" style="width: 85%"></div>
                                </div>
                                <div class="row small text-center">
                                    <div class="col-6">
                                        <div class="fw-semibold">Prog:</div>
                                        <div class="text-primary">2550</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="fw-semibold">Real:</div>
                                        <div class="text-success">1843</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        // Funciones para colores (las mismas que tenías)
        function getColorClass(porcentaje) {
            if (porcentaje >= 115) return 'text-primary';
            if (porcentaje >= 95) return 'text-success';
            if (porcentaje >= 85) return 'text-warning';
            if (porcentaje >= 70) return 'text-orange';
            return 'text-danger';
        }

        function getProgressColor(porcentaje) {
            if (porcentaje >= 115) return 'bg-primary';
            if (porcentaje >= 95) return 'bg-success';
            if (porcentaje >= 85) return 'bg-warning';
            if (porcentaje >= 70) return 'bg-orange';
            return 'bg-danger';
        }

        function extraerPorcentaje(texto) {
            return parseInt(texto) || 0;
        }

        function aplicarColoresAutomaticos() {
            // Aplicar colores a porcentajes mensuales
            $('.porcentaje-mes').each(function() {
                const porcentaje = extraerPorcentaje($(this).text());
                $(this).addClass(getColorClass(porcentaje));
            });

            // Aplicar colores a porcentajes trimestrales
            $('.porcentaje-trimestre').each(function() {
                const porcentaje = extraerPorcentaje($(this).text());
                $(this).addClass(getColorClass(porcentaje));

                const trimestre = $(this).data('trimestre');
                const progressBar = $(this).closest('.tablero-individual').find('.progress-trimestre-' + trimestre);
                if (progressBar.length) {
                    progressBar.css('width', Math.min(porcentaje, 100) + '%');
                    progressBar.addClass(getProgressColor(porcentaje));
                }
            });

            // Aplicar color a porcentaje anual
            $('.porcentaje-anual').each(function() {
                const porcentaje = extraerPorcentaje($(this).text());
                $(this).addClass(getColorClass(porcentaje));

                const progressAnual = $(this).closest('.tablero-individual').find('.progress-anual');
                if (progressAnual.length) {
                    progressAnual.css('width', Math.min(porcentaje, 100) + '%');
                    progressAnual.addClass(getProgressColor(porcentaje));
                }
            });
        }
    </script>

    <style>
        .text-orange {
            color: #fd7e14 !important;
        }

        .bg-orange {
            background-color: #fd7e14 !important;
        }

        .tablero-individual {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #dee2e6 !important;
        }
    </style>
}