@{
    ViewData["Title"] = "Tablero de Control";
    int numeroRegistros = ViewBag.NumeroRegistros ?? 0;
    int anoFiscal = ViewBag.AnoFiscal ?? DateTime.Now.Year;
}

<div class="container-fluid mt-4">

    <!-- Encabezado -->
    <div class="glass-effect rounded-3 p-3 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="fw-bold titulo mb-1">TABLERO DE CONTROL</h2>
                <p class="mb-0 text-muted">Ejercicio Fiscal: @anoFiscal - Total de Actividades: @numeroRegistros</p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-controller="Monitoreo" asp-action="Monitoreo"
                   class="btn btn-outline-primary">
                    ← Volver al Monitoreo
                </a>
            </div>
        </div>
    </div>

    @if (numeroRegistros == 0)
    {
        <div class="alert alert-info text-center">
            <h5>No hay datos disponibles para mostrar</h5>
            <p>No se encontraron registros para los criterios seleccionados.</p>
        </div>
    }
    else
    {
        <div id="contenedor-tableros">
            <!-- Los tableros se generarán aquí automáticamente -->
        </div>
    }
</div>

@section Scripts {
    <script>
        // 1. Cargar el JSON serializado de C# y parsearlo a un objeto JS
        const datosTableroJSON = '@Html.Raw(ViewBag.DatosJson ?? "[]")';
        let datosTablero = [];

        try {
            datosTablero = JSON.parse(datosTableroJSON);
        } catch (e) {
            console.error("Error al parsear datos JSON:", e);
        }

        $(document).ready(function() {
            const numeroRegistros = datosTablero.length;
            const contenedor = $('#contenedor-tableros');

            if (numeroRegistros > 0) {
                // 2. Iterar sobre los datos reales (forEach)
                datosTablero.forEach((item, index) => {
                    // El número de tablero es el índice + 1
                    const numeroTablero = index + 1;

                    // Pasar el objeto de datos (item) a la función crearTablero
                    const tableroHTML = crearTablero(numeroTablero, item);
                    contenedor.append(tableroHTML);
                });

                // Aplicar colores después de generar todos los tableros
                setTimeout(aplicarColoresAutomaticos, 100);
            }
        });

        // ----------------------------------------------------
        // 3. Modificar la función crearTablero para aceptar y usar los datos
        function crearTablero(numeroTablero, data) {

            // Calculamos los porcentajes necesarios en el lado del cliente (JS)
            const porcentajeAnual = data.Realizado.Total > 0 ?
                Math.round((data.Realizado.Total / data.Programado.Total) * 100) : 0;

            // Los meses en tu data JSON (Ene, Feb, etc.)
            const mesesAbreviados = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            // Función para calcular el porcentaje de un mes
            const calcularPorcentajeMes = (mes) => {
                const prog = data.Programado[mes] || 0;
                const real = data.Realizado[mes] || 0;
                return prog > 0 ? Math.round((real / prog) * 100) : 0;
            };

            // Función para calcular el porcentaje de un trimestre
            const calcularPorcentajeTrimestre = (m1, m2, m3) => {
                const progTotal = data.Programado[m1] + data.Programado[m2] + data.Programado[m3];
                const realTotal = data.Realizado[m1] + data.Realizado[m2] + data.Realizado[m3];
                return progTotal > 0 ? Math.round((realTotal / progTotal) * 100) : 0;
            };

            const trim1Porcentaje = calcularPorcentajeTrimestre('Ene', 'Feb', 'Mar');
            const trim2Porcentaje = calcularPorcentajeTrimestre('Abr', 'May', 'Jun');
            const trim3Porcentaje = calcularPorcentajeTrimestre('Jul', 'Ago', 'Sep');
            const trim4Porcentaje = calcularPorcentajeTrimestre('Oct', 'Nov', 'Dic');


            return `
            <div class="tablero-individual mb-5 border-bottom pb-4" data-tablero="${numeroTablero}">

                <div class="glass-effect rounded-3 p-3 mb-3 bg-primary bg-opacity-10">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="fw-bold titulo mb-1">
                                ${data.Componente} / ${data.Actividad}
                            </h4>
                            <p class="mb-1 text-muted">${data.DescripcionActividad}</p>
                            <small class="text-muted">${data.ProgramaSocial}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-info fs-6">ID Proceso ${data.IdProceso}</span>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-3 p-3 mb-3">
                    <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">INFORMACIÓN DEL PROGRAMA</h5>
                    <div class="row small">
                        <div class="col-md-6 border-end pe-3">
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Componente:</span>
                                <span>${data.Componente}</span>
                            </div>
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Número de Actividad:</span>
                                <span>${data.Actividad}</span>
                            </div>
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Programa Social:</span>
                                <span>${data.ProgramaSocial}</span>
                            </div>
                        </div>
                        <div class="col-md-6 ps-3">
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Unidad de Medida:</span>
                                <span>${data.UnidadMedida || 'N/A'}</span>
                            </div>
                            <div class="mb-2">
                                <span class="fw-semibold titulo">Descripción:</span>
                                <span>${data.DescripcionActividad}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-3 p-3 mb-3" style="background-color: white">
                    <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">CALENDARIZACIÓN ANUAL</h5>
                    <div class="row">

                        <div class="col-md-6 border-end pe-3">
                            <h6 class="fw-semibold text-primary mb-2">PROGRAMADO</h6>
                            <div class="table-responsive">
                                <table class="table table-sm text-center mb-2">
                                    <thead class="bg-primary text-white">
                                        <tr>
                                            <th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th>
                                            <th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            ${mesesAbreviados.map(mes => `<td>${data.Programado[mes] || 0}</td>`).join('')}
                                            <td class="fw-bold bg-info bg-opacity-10">${data.Programado.Total}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-md-6 ps-3">
                            <h6 class="fw-semibold text-success mb-2">REALIZADO</h6>
                            <div class="table-responsive">
                                <table class="table table-sm text-center mb-2">
                                    <thead class="bg-success text-white">
                                        <tr>
                                            <th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th>
                                            <th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            ${mesesAbreviados.map(mes => `<td>${data.Realizado[mes] || 0}</td>`).join('')}
                                            <td class="fw-bold bg-success bg-opacity-10">${data.Realizado.Total}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-3 p-3 mb-3" style="background-color: white">
                    <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">AVANCE MENSUAL</h5>
                    <div class="table-responsive">
                        <table class="table table-sm text-center mb-1">
                            <thead class="bg-warning text-dark">
                                <tr>
                                    <th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th>
                                    <th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    ${mesesAbreviados.map(mes =>
                                        `<td><div class="fw-bold porcentaje-mes" data-mes="${mes.toLowerCase()}">${calcularPorcentajeMes(mes)}%</div></td>`
                                    ).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="glass-effect rounded-3 p-3" style="background-color: white">
                    <div class="row">
                        <div class="col-md-8 border-end pe-3">
                            <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">TRIMESTRAL</h5>
                            <div class="row text-center">
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">1ER</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="1">${trim1Porcentaje}%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-1" style="width: ${Math.min(trim1Porcentaje, 100)}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">2DO</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="2">${trim2Porcentaje}%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-2" style="width: ${Math.min(trim2Porcentaje, 100)}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">3ER</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="3">${trim3Porcentaje}%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-3" style="width: ${Math.min(trim3Porcentaje, 100)}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="border rounded p-2">
                                        <small class="fw-semibold">4TO</small>
                                        <div class="h6 fw-bold porcentaje-trimestre" data-trimestre="4">${trim4Porcentaje}%</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar progress-trimestre-4" style="width: ${Math.min(trim4Porcentaje, 100)}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 ps-3">
                            <h5 class="fw-semibold titulo mb-3 border-bottom pb-2 text-center">ANUAL</h5>
                            <div class="text-center">
                                <div class="h3 fw-bold porcentaje-anual">${porcentajeAnual}%</div>
                                <div class="progress mb-2" style="height: 12px;">
                                    <div class="progress-bar progress-anual" style="width: ${Math.min(porcentajeAnual, 100)}%"></div>
                                </div>
                                <div class="row small text-center">
                                    <div class="col-6">
                                        <div class="fw-semibold">Prog:</div>
                                        <div class="text-primary">${data.Programado.Total}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="fw-semibold">Real:</div>
                                        <div class="text-success">${data.Realizado.Total}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        // Funciones para colores (las mismas que tenías)
        function getColorClass(porcentaje) {
            if (porcentaje >= 115) return 'text-primary';
            if (porcentaje >= 95) return 'text-success';
            if (porcentaje >= 85) return 'text-warning';
            if (porcentaje >= 70) return 'text-orange';
            return 'text-danger';
        }

        function getProgressColor(porcentaje) {
            if (porcentaje >= 115) return 'bg-primary';
            if (porcentaje >= 95) return 'bg-success';
            if (porcentaje >= 85) return 'bg-warning';
            if (porcentaje >= 70) return 'bg-orange';
            return 'bg-danger';
        }

        function extraerPorcentaje(texto) {
            return parseInt(texto) || 0;
        }

        function aplicarColoresAutomaticos() {
            // Aplicar colores a porcentajes mensuales
            $('.porcentaje-mes').each(function() {
                const porcentaje = extraerPorcentaje($(this).text());
                $(this).addClass(getColorClass(porcentaje));
            });

            // Aplicar colores a porcentajes trimestrales
            $('.porcentaje-trimestre').each(function() {
                const porcentaje = extraerPorcentaje($(this).text());
                $(this).addClass(getColorClass(porcentaje));

                const trimestre = $(this).data('trimestre');
                const progressBar = $(this).closest('.tablero-individual').find('.progress-trimestre-' + trimestre);
                if (progressBar.length) {
                    progressBar.css('width', Math.min(porcentaje, 100) + '%');
                    progressBar.addClass(getProgressColor(porcentaje));
                }
            });

            // Aplicar color a porcentaje anual
            $('.porcentaje-anual').each(function() {
                const porcentaje = extraerPorcentaje($(this).text());
                $(this).addClass(getColorClass(porcentaje));

                const progressAnual = $(this).closest('.tablero-individual').find('.progress-anual');
                if (progressAnual.length) {
                    progressAnual.css('width', Math.min(porcentaje, 100) + '%');
                    progressAnual.addClass(getProgressColor(porcentaje));
                }
            });
        }
    </script>

    <style>
        .text-orange {
            color: #fd7e14 !important;
        }

        .bg-orange {
            background-color: #fd7e14 !important;
        }

        .tablero-individual {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #dee2e6 !important;
        }
    </style>
}