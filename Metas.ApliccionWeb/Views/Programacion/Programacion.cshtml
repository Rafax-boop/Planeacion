@model Metas.AplicacionWeb.Models.ViewModels.VMDepartamentos
@{
    ViewData["Title"] = "Iniciar Programación";
}
<div class="mt-5 pb-4 pt-3 rounded-5 glass-effect" style="padding-left: 20px; padding-right: 25px">
    <div class="row">
        <div class="col">
            <div class="mt-2 text-center">
                <label class="form-label fs-3 fw-bold titulo">Año Fiscal</label>
            </div>
        </div>
        <div class="col">
            <div class="mt-2 text-center">
                <label class="form-label fs-3 fw-bold titulo">Departamentos</label>
            </div>
        </div>
    </div>
    <div class="row g-1">
        <div class="col">
            <div class="col-12">
                <select class="titulo form-select input-arena" id="selectAnoFiscal">
                    @{
                        var anoActual = DateTime.Now.Year;
                        var anoMaximo = anoActual + 1;
                        var anoMinimo = anoActual - 5;

                        for (int ano = anoMaximo; ano >= anoMinimo; ano--)
                        {
                            <option value="@ano">@ano</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="col">
            <div class="col-12" style="margin-left: 6px">
                <select class="titulo form-select input-arena" id="selectDepartamento">                    
                    @if (User.IsInRole("Administrador"))
                    {
                        <option value="">-- Seleccione un departamento --</option>
                        @foreach (var act in Model.ListaDepartamentos)
                        {
                            <option value="@act.Value">@act.Text</option>
                        }
                    }
                    else
                    {
                        var departamentoUsuarioTexto = User.Claims.FirstOrDefault(c => c.Type == "Departamento")?.Value;

                        var departamentoUsuarioObjeto = Model.ListaDepartamentos
                        .FirstOrDefault(d => d.Text == departamentoUsuarioTexto);

                        if (departamentoUsuarioObjeto != null)
                        {
                            // Si se encuentra, usamos el Value (ID) y el Text (Nombre)
                            <option value="@departamentoUsuarioObjeto.Value">@departamentoUsuarioObjeto.Text</option>
                        }
                        else
                        {
                            // Opcional: Manejo si no se encuentra (solo mostrar el texto como fallback)
                            <option value="">xd</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div>
            <div class="mt-4 text-center">
                <button class="boton-rojo" type="button" id="btnBuscar">Buscar</button>
            </div>
        </div>
    </div>
</div>

<!-- Sección que se mostrará después de buscar -->
<div id="seccionResultados" class="mt-4 pb-4 pt-3 rounded-5 glass-effect" style="padding-left: 20px; padding-right: 25px; display: none;">
    <div class="text-center mb-3">
        <button class="boton-rojo" type="button" id="btnIniciarProgramacion" >Iniciar Programación</button>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="tablaDatos">
            <thead class="table-dark">
                <tr>
                    <th>Pp</th>
                    <th>Componente</th>
                    <th>Actividad</th>
                    <th>Descripción de la Actividad</th>
                    <th>Programa o servicio de asistencia social</th>
                    <th>Área</th>
                    <th>Departamento</th>
                    <th>Estatus</th>
                </tr>
            </thead>
            <tbody id="tbodyDatos">
                <!-- Los datos se cargarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>
    
    <!-- Mensaje de carga -->
    <div id="mensajeCarga" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando datos...</p>
    </div>
    
    <!-- Mensaje cuando no hay datos -->
    <div id="mensajeSinDatos" class="alert alert-info text-center" style="display: none;">
        No se encontraron datos para los criterios seleccionados.
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Evento click del botón Buscar
            $('#btnBuscar').click(function() {
                var anoFiscal = $('#selectAnoFiscal').val();
                var departamento = $('#selectDepartamento').val();

                // Validar que se haya seleccionado un departamento
                if (!departamento) {
                    alert('Por favor, seleccione un departamento');
                    return;
                }

                // Mostrar la sección de resultados
                $('#seccionResultados').slideDown();

                // Mostrar mensaje de carga
                $('#mensajeCarga').show();
                $('#tablaDatos').hide();
                $('#mensajeSinDatos').hide();

                // Llamada AJAX para obtener los datos
                $.ajax({
                    url: '@Url.Action("ObtenerDatos", "Programacion")',
                    type: 'GET',
                    data: {
                        anoFiscal: anoFiscal,
                        departamento: departamento
                    },
                    success: function(response) {
                        $('#mensajeCarga').hide();

                        // 1. Mostrar/Ocultar el botón basado en el rango de fechas
                        if (response.fechaHabilitada) {
                            $('#btnIniciarProgramacion').show(); // La fecha actual está en el rango
                        } else {
                            // 💡 Es buena práctica deshabilitarlo si no se puede usar, aunque ya esté oculto
                            $('#btnIniciarProgramacion').hide().prop('disabled', true);
                        }

                        if (response.success && response.datos && response.datos.length > 0) {
                            // Limpiar el tbody
                            $('#tbodyDatos').empty();

                            var esAdmin = response.esAdmin;

                            // Llenar la tabla con los datos
                            $.each(response.datos, function(index, item) {
                                var prefijoActividad = '';
                                if (item.pp && item.pp.toLowerCase() === 'agenda') {
                                    prefijoActividad = 'T';
                                }

                                // Concatenar componente + actividad (con T solo si es agenda)
                                var actividadCompleta = prefijoActividad + (item.componente || '') + '.' + (item.actividad || '');

                                var btnEliminar = '';
                                if(esAdmin){
                                    btnEliminar = '<br><button type="button" class="btn btn-danger btn-sm btn-eliminar" data-id="' + item.idProceso + '">Eliminar</button>';
                                }
                                var btnEditar = '<button type="button" class="btn btn-primary btn-sm btn-editar" data-id="' + item.idProceso + '">Editar</button>';

                                var fila = '<tr>' +
                                    '<td>' + item.pp + btnEliminar + '</td>' +
                                    '<td>' + item.componente + '</td>' +
                                    '<td>' + actividadCompleta + '</td>' +
                                    '<td>' + item.descripcionActividad + '</td>' +
                                    '<td>' + item.programaSocial + '</td>' +
                                    '<td>' + item.area + '</td>' +
                                    '<td>' + item.departamento + '</td>' +
                                    '<td>' + item.idEstatus + btnEditar + '</td>' +
                                '</tr>';
                                $('#tbodyDatos').append(fila);
                            });

                            $('#tablaDatos').show();
                            
                        } else {
                            $('#mensajeSinDatos').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#mensajeCarga').hide();
                        alert('Error al cargar los datos: ' + error);
                    }
                });
            });

            $(document).on('click', '.btn-eliminar', function() {
                // 1. Obtener el ID del registro a eliminar
                var idProceso = $(this).data('id');
                console.log(idProceso);

                // 2. Confirmación al usuario
                if (confirm('¿Está seguro de que desea eliminar este registro? Esta acción es irreversible y eliminará datos en 4 tablas.')) {

                    // 3. Llamada AJAX al controlador
                    $.ajax({
                        url: '@Url.Action("EliminarRegistro", "Programacion")',
                        type: 'POST', // Usamos POST como lo definimos en el controlador
                        data: {
                            id: idProceso // Enviamos el ID al controlador
                        },
                        success: function(response) {
                            if (response.success) {
                                alert(response.mensaje);
                                // Opcional: Recargar la tabla sin recargar la página
                                $('#btnBuscar').click();
                            } else {
                                alert('Error: ' + response.mensaje);
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('Error en la comunicación con el servidor al intentar eliminar.');
                        }
                    });
                }
            });

            $('#btnIniciarProgramacion').click(function() {
                var anoFiscal = $('#selectAnoFiscal').val();
                var departamento = $('#selectDepartamento').val();

                var urlRedireccion = '@Url.Action("RegistrarProgramacion", "Programacion")' +
                                     '?anoFiscal=' + anoFiscal +
                                     '&departamentoId=' + departamento;

                window.location.href = urlRedireccion;
            });
        });
    </script>
}