@model Metas.BLL.DTO.ProgramacionDTO

@{
    ViewData["Title"] = "Editar Programación";
}

<div class="container-fluid mt-5">
    <h1 class="text-center mb-4 titulo fw-semibold pt-2 glass-effect rounded-5 pb-2">EDITAR FICHA TÉCNICA DE ACTIVIDADES</h1>

    @* Datos del solicitante *@
    <div class="d-flex border mb-4 rounded-4 shadow">
        <div class="w-25 p-3 rounded-start-4 align-content-center glass-effect">
            <h5 class="fw-semibold titulo text-center">
                Datos del solicitante
            </h5>
        </div>

        <div class="w-75">
            <div class="d-flex border-bottom p-2">
                <div class="w-50 my-2">1. FECHA DE ELABORACIÓN:</div>
                <div class="w-50 fw-semibold text-center my-2">@DateTime.Now.ToString("dd/MM/yyyy")</div>
            </div>

            <div class="d-flex p-2 row">
                <label class="col-md-4 align-content-center">2. NOMBRE DEL ÁREA OPERATIVA <br /> RESPONSABLE (AOR):</label>
                <div class="col-8 row">
                    <div class="col-md-6">
                        <h5 class="fw-light">Area:</h5>
                        <textarea disabled class="form-control input-arena titulo fw-semibold" rows="2" id="inputArea">@Model.Area</textarea>
                    </div>
                    <div class="col-md-6">
                        <h5 class="fw-light">Departamento:</h5>
                        <textarea disabled class="form-control input-arena titulo fw-semibold" rows="2" id="inputDepartamento">@Model.Departamento</textarea>
                    </div>
                </div>
            </div>

            <div class="d-flex p-2">
                <div class="w-50 align-content-center">3. CORREO ELECTRÓNICO:</div>
                <div class="w-50 my-2 mx-2">
                    <input type="email" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control titulo" placeholder="ejemplo@correo.com" id="inputCorreo" value="@Model.CorreoContacto">
                </div>
            </div>
        </div>
    </div>

    @* Datos de la solicitud *@
    <div class="p-3 mb-4 rounded-4 shadow">
        <h5 class="mb-2 text-center border-bottom pb-3 fw-semibold titulo pt-2 glass-effect rounded-5">DATOS DE LA SOLICITUD</h5>

        <div class="row my-3 border-bottom pb-3">
            <label class="col-md-6 align-content-center">4. PROGRAMA PRESUPUESTARIO:</label>
            <div class="col-md-5 align-content-center">
                <select @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control titulo" id="selectPrograma" data-campo="4">
                    <option value="">Seleccione Programa</option>
                    @if (Model.ListaProgramas != null)
                    {
                        foreach (var programa in Model.ListaProgramas)
                        {
                            if (programa.Value == Model.Pp)
                            {
                                <option value="@programa.Value" selected>@programa.Text</option>
                            }
                            else
                            {
                                <option value="@programa.Value">@programa.Text</option>
                            }
                        }
                    }
                </select>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="4" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        <div class="row mb-3 border-bottom pb-3">
            <label class="align-content-center col-md-6">5. NÚMERO DE COMPONENTE:</label>
            <div class="col-md-5 align-content-center">
                <select @(!ViewBag.EsAdministrador ? "disabled" : "")
                        class="input-arena form-control titulo"
                        id="selectComponente"
                        data-campo="5">
                    <option value="">Seleccione Componente</option>
                    @if (Model.ListaComponentes != null && Model.ListaComponentes.Any())
                    {
                        foreach (var componente in Model.ListaComponentes)
                        {
                            if (componente.Text == Model.NComponente)
                            {
                                <option value="@componente.Value" data-programa="@componente.Group.Name" selected>@componente.Text</option>
                            }
                            else
                            {
                                <option value="@componente.Value" data-programa="@componente.Group.Name">@componente.Text</option>
                            }
                        }
                    }
                </select>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="5" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        <div class="row pb-1 border-bottom mb-3 pb-3">
            <label class="align-content-center col-md-6">6. NÚMERO DE ACTIVIDAD:</label>
            <div class="col-md-5 align-content-center">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") required class="input-arena form-control titulo" id="inputActividad" value="@Model.NActividad" data-campo="6">
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="6" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        @* Justificacion *@
        <div class="border-bottom mb-3 pb-3">
            <div class="row">
                <div class="col-md-11">
                    <label>7. JUSTIFICACIÓN</label>
                    <textarea required class="input-arena form-control" @(!ViewBag.EsAdministrador ? "disabled" : "") rows="2" id="inputJustificacion" data-campo="7">@Model.Justificacion</textarea>
                </div>
                <div class="col-md-1 align-content-center">
                    <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                            data-campo="7" data-bs-toggle="tooltip" title="Agregar comentario">
                        <i class="fas fa-comment-medical"></i>
                    </button>
                </div>
            </div>
        </div>

        @* Documentacion soporte *@
        <div class="mb-3 pb-3 border-bottom">
            <div class="row">
                <div class="col-md-11">
                    <label>8. DOCUMENTACIÓN SOPORTE DE LA JUSTIFICACIÓN</label>
                    <textarea @(!ViewBag.EsAdministrador ? "disabled" : "") required class="input-arena form-control" rows="2" id="inputDocumentacion" data-campo="8">@Model.DescripcionDocumento</textarea>
                </div>
                <div class="col-md-1 align-content-center">
                    <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                            data-campo="8" data-bs-toggle="tooltip" title="Agregar comentario">
                        <i class="fas fa-comment-medical"></i>
                    </button>
                </div>
            </div>
        </div>

        @* Origen de recursos *@
        <div class="d-flex align-items-center py-2 pb-4">
            <div class="w-50 pe-3 mt-2 align-items-center">
                <label>9. ORIGEN DE RECURSOS</label>
            </div>
            <div class="w-50 mt-2">
                <div class="row g-2">
                    <div class="col-6">
                        <h5 class="fw-light">Recurso Federal</h5>
                        <select required @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control titulo" id="selectFederal" data-campo="9">
                            <option value="">Seleccione</option>
                            <option value="Si" selected="@(Model.RecursoFederal == "Si")">Sí</option>
                            <option value="No" selected="@(Model.RecursoFederal == "No")">No</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <h5 class="fw-light">Recurso Estatal</h5>
                        <select required @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control titulo" id="selectEstatal" data-campo="9">
                            <option value="">Seleccione</option>
                            <option value="Si" selected="@(Model.RecursoEstatal == "Si")">Sí</option>
                            <option value="No" selected="@(Model.RecursoEstatal == "No")">No</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="w-auto ms-2 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="9" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>
    </div>

    <hr>

    @* Datos generales *@
    <h2 class="text-center my-4 titulo fw-semibold pt-2 pb-2 glass-effect rounded-5 ">DATOS GENERALES</h2>
    
    <div class="border p-3 mb-4 mt-4 rounded-4 shadow">
        <div class="row border-bottom">
            <label class="col-md-4 align-content-center">10. PROGRAMA SOCIAL, SERVICIO Y/O PROYECTO</label>
            <div class="col-md-7 mb-3">
                <textarea required id="inputPrograma" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control" rows="2">@Model.ProgramaSocial</textarea>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="10" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>
        <div class="row border-bottom">
            <label class="col-md-4 align-content-center">11. DESCRIPCIÓN DE LA ACTIVIDAD</label>
            <div class="col-md-7 my-3">
                <textarea required id="inputDescripcion" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control" rows="2">@Model.DescripcionActividad</textarea>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="11" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>
        <div class="row border-bottom">
            <label class="col-md-4 align-content-center">12. NOMBRE DEL INDICADOR</label>
            <div class="col-md-7 my-3">
                <textarea required id="inputIndicador" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control" rows="2">@Model.NombreIndicador</textarea>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="12" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>
        <div class="row border-bottom">
            <label class="col-md-4 align-content-center">13. DEFINICIÓN DEL INDICADOR</label>
            <div class="col-md-7 my-3">
                <textarea required id="inputDefinicion" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control" rows="2">@Model.DefinicionIndicador</textarea>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="13" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        @* Calendarización *@
        <div class="row border-bottom py-3 mb-3">
            <label class="col-md-4 align-content-center">14. CALENDARIZACIÓN</label>
        </div>

        <div class="row">
            @* Encabezados de trimestres *@
            <div class="col-md-3 mb-3">
                <div class="text-center fw-semibold text-muted">TRIMESTRES</div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="text-center titulo fw-semibold border-bottom pb-1">1ER TRIMESTRE</div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="text-center titulo fw-semibold border-bottom pb-1">2DO. TRIMESTRE</div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="text-center titulo fw-semibold border-bottom pb-1">3ER. TRIMESTRE</div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="text-center titulo fw-semibold border-bottom pb-1">4TO. TRIMESTRE</div>
            </div>
        </div>

        @* Fila para SERVICIOS *@
        <div class="row align-items-center pb-2 mb-2">
            <div class="col-md-3 text-center">
                <label class="fw-light">SERVICIOS</label>
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="primerServicio" class="input-arena form-control titulo text-center" value="@Model.PrimerServicio" min="0">
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="segundoServicio" class="input-arena form-control titulo text-center" value="@Model.SegundoServicio" min="0">
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="tercerServicio" class="input-arena form-control titulo text-center" value="@Model.TercerServicio" min="0">
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="cuartoServicio" class="input-arena form-control titulo text-center" value="@Model.CuartoServicio" min="0">
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="14" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        @* Fila para PERSONAS *@
        <div class="row align-items-center mb-3">
            <div class="col-md-3 text-center">
                <label class="fw-light">PERSONAS</label>
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="primerPersona" class="input-arena form-control titulo text-center" value="@Model.PrimerPersona" min="0">
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="segundoPersona" class="input-arena form-control titulo text-center" value="@Model.SegundoPersona" min="0">
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="tercerPersona" class="input-arena form-control titulo text-center" value="@Model.TercerPersona" min="0">
            </div>
            <div class="col-md-2">
                <input type="number" @(!ViewBag.EsAdministrador ? "disabled" : "") id="cuartoPersona" class="input-arena form-control titulo text-center" value="@Model.CuartoPersona" min="0">
            </div>
        </div>

        <div class="row border-bottom border-top">
            <label class="col-md-4 align-content-center">15. UNIDAD DE MEDIDA</label>
            <div class="col-md-7 my-3">
                <select required @(!ViewBag.EsAdministrador ? "disabled" : "")
                        class="input-arena form-control titulo"
                        id="selectMedida"
                        data-campo="15">
                    <option value="">Seleccione opción</option>
                    @if (Model.ListaMedidas != null)
                    {
                        foreach (var medida in Model.ListaMedidas)
                        {
                            if (medida.Value == Model.UnidadMedida || medida.Text == Model.UnidadMedida)
                            {
                                <option value="@medida.Value" selected>@medida.Text</option>
                            }
                            else
                            {
                                <option value="@medida.Value">@medida.Text</option>
                            }
                        }
                    }
                </select>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="15" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        <div class="row border-bottom">
            <label class="col-md-4 align-content-center">16. MEDIOS DE VERIFICACIÓN</label>
            <div class="col-md-7 my-3">
                <textarea required id="inputMedios" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control" rows="2">@Model.MediosVerificacion</textarea>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="16" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        <div class="row border-bottom">
            <label class="col-md-4 align-content-center">17. SERIE DE INFORMACIÓN DISPONIBLE</label>
            <div class="col-md-3 my-3">
                <select required @(!ViewBag.EsAdministrador ? "disabled" : "")
                        class="titulo form-select input-arena"
                        id="selectDesde"
                        data-campo="17">
                    <option value="">Seleccione Desde</option>
                    @{
                        var anoActual = DateTime.Now.Year;
                        var anoMinimo = anoActual - 5;

                        for (int ano = anoActual; ano >= anoMinimo; ano--)
                        {
                            <option value="@ano"
                                    selected="@(ano.ToString() == Model.SerieInformacionDesde)">
                                @ano
                            </option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-4 my-3">
                <select @(!ViewBag.EsAdministrador ? "disabled" : "")
                        class="titulo form-select input-arena"
                        id="selectHasta"
                        data-campo="17">
                    <option value="">Seleccione Hasta</option>
                    @{
                        for (int ano = anoActual; ano >= anoMinimo; ano--)
                        {
                            <option value="@ano"
                                    selected="@(ano.ToString() == Model.SerieInformacionHasta)">
                                @ano
                            </option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="17" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        <div class="row border-bottom mb-2">
            <label class="col-md-4 align-content-center">18. FUENTES DE INFORMACIÓN</label>
            <div class="col-md-7 my-3">
                <textarea required id="inputFuentes" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control" rows="2">@Model.FuenteInformacion</textarea>
            </div>
            <div class="col-md-1 align-content-center">
                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                        data-campo="18" data-bs-toggle="tooltip" title="Agregar comentario">
                    <i class="fas fa-comment-medical"></i>
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 border-end my-3">
                <div class="row align-items-center h-100">
                    <div class="col-md-6">
                        <label class="mb-0 d-flex align-items-center h-100">19. INTERVIENEN DELEGACIONES REGIONALES</label>
                    </div>
                    <div class="col-md-5">
                        <select id="selectDelegaciones" @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control titulo">
                            <option value="">Seleccione</option>
                            <option value="Si" selected="@(Model.IntervienenDelegaciones == "Si")">Sí</option>
                            <option value="No" selected="@(Model.IntervienenDelegaciones == "No")">No</option>
                        </select>
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="19" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row align-items-center h-100">
                    <div class="col-md-6">
                        <label class="mb-0 d-flex align-items-center h-100">20. ¿DE QUÉ MANERA?</label>
                    </div>
                    <div class="col-md-5">
                        <textarea @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputDelegaciones" class="input-arena form-control" rows="2">@Model.IntervienenDelegacionesManera</textarea>
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="20" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Determinación de Metas *@
    <div class="border p-3 mb-4 rounded-4 shadow">
        <h5 class="pt-2 glass-effect rounded-5 text-center border-bottom pb-2 fw-semibold titulo">DETERMINACIÓN DE METAS</h5>

        <div class="row">
            <div class="col-md-6 border-end">
                <div class="text-center fw-light py-2 border-bottom" style="background-color: #F4F4F4">
                    LÍNEA BASE
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-6">
                        <label class="mb-0">21. AÑO</label>
                    </div>
                    <div class="col-md-5">
                        <select @(!ViewBag.EsAdministrador ? "disabled" : "")
                                class="input-arena form-control titulo"
                                id="selectAnoBase"
                                data-campo="21">
                            <option value="">Seleccione Año</option>
                            @{
                                for (int ano = anoActual; ano >= anoMinimo; ano--)
                                {
                                    <option value="@ano"
                                            selected="@(ano == Model.AnoBase)">
                                        @ano
                                    </option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="21" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-6">
                        <label class="mb-0">22. PORCENTAJE DE CUMPLIMIENTO</label>
                    </div>
                    <div class="col-md-5">
                        <input id="inputPorcentajeBase" @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center" value="@Model.PorcentajeBase" min="0" max="100">
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="22" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-6">
                        <label class="mb-0">23. NO. DE BIEN O SERVICIO ENTREGADO</label>
                    </div>
                    <div class="col-md-5">
                        <input @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputServicioBase" type="number" class="input-arena form-control titulo text-center" value="@Model.ServicioBase" min="0">
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="23" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>

                <div class="row align-items-center py-2">
                    <div class="col-md-6">
                        <label class="mb-0">24. NO. DE PERSONAS ATENDIDAS</label>
                    </div>
                    <div class="col-md-5">
                        <input @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputPersonasBase" type="number" class="input-arena form-control titulo text-center" value="@Model.PersonasBase" min="0">
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="24" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="text-center fw-light py-2 border-bottom" style="background-color: #F4F4F4">
                    META Y PERIODO DE CUMPLIMIENTO
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-6">
                        <label class="mb-0">25. AÑO</label>
                    </div>
                    <div class="col-md-5">
                        <input id="inputAnoMeta" type="text" class="input-arena form-control titulo text-center fw-semibold" value="@Model.AnoMeta" @(!ViewBag.EsAdministrador ? "disabled" : "")>
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="25" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-6">
                        <label class="mb-0">26. PORCENTAJE DE CUMPLIMIENTO</label>
                    </div>
                    <div class="col-md-5">
                        <input id="inputPorcentajeMeta" @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center" value="@Model.PorcentajeMeta" min="0" max="100">
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="26" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-6">
                        <label class="mb-0">27. NO. DE BIEN O SERVICIO A ENTREGAR</label>
                    </div>
                    <div class="col-md-5">
                        <input id="inputServicioMeta" @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center" value="@Model.ServicioMeta" min="0">
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="27" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>

                <div class="row align-items-center py-2">
                    <div class="col-md-6">
                        <label class="mb-0">28. NO. DE PERSONAS POR ATENDER</label>
                    </div>
                    <div class="col-md-5">
                        <input id="inputServicioMetas" @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center" value="@Model.PersonasMeta" min="0">
                    </div>
                    <div class="col-md-1 align-content-center">
                        <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                data-campo="28" data-bs-toggle="tooltip" title="Agregar comentario">
                            <i class="fas fa-comment-medical"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Meta Anual *@
    <div class="border p-3 mb-4 rounded-4 shadow" id="metaAnualForm">
        <h5 class="mb-2 text-center border-bottom pb-3 fw-semibold titulo pt-2 glass-effect rounded-5">META ANUAL</h5>

        @* Sección Bien/Servicio y Personas *@
        <div class="border-bottom pb-3">
            <div class="row">
                <div class="col-md-6 border-end align-content-center">
                    <div class="row align-items-center py-2">
                        <div class="col-md-11">
                            <label class="mb-0 align-content-center">29. BIEN O SERVICIO</label>
                        </div>
                        <div class="col-md-1 align-content-center">
                            <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                    data-campo="29" data-bs-toggle="tooltip" title="Agregar comentario">
                                <i class="fas fa-comment-medical"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="col-md-12">
                        <div class="row align-items-center py-2">
                            <div class="col-md-12">
                                <label class="mb-0">30. PERSONAS</label>
                            </div>
                            <div class="col-md-10">
                                <select @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control titulo" id="selectPersonas">
                                    <option value="">Seleccione Personas / Instituciones</option>
                                    <option value="Personas" selected="@(Model.Beneficiarios == "Personas")">Personas</option>
                                    <option value="Instituciones" selected="@(Model.Beneficiarios == "Instituciones")">Instituciones</option>
                                </select>
                            </div>
                            <div class="col-md-2 align-content-center">
                                <button type="button" class="btn btn-sm btn-comentario btn-comentario-sin"
                                        data-campo="30" data-bs-toggle="tooltip" title="Agregar comentario">
                                    <i class="fas fa-comment-medical"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-center py-2">
                        <div class="col-md-4">
                            <label class="mb-0">Acumulable</label>
                        </div>
                        <div class="col-md-8">
                            <select @(!ViewBag.EsAdministrador ? "disabled" : "") class="input-arena form-control titulo" id="selectAcumulable">
                                <option value="">Seleccione opción</option>
                                <option value="no" selected="@(Model.SelectAcumulable == "no")">No</option>
                                <option value="si" selected="@(Model.SelectAcumulable == "si")">Sí</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Sección Meses *@
        <div class="mt-4">
            @{
                var mesesPrimerSemestre = new[] { "ENE", "FEB", "MAR", "ABR", "MAY", "JUN" };
                var mesesSegundoSemestre = new[] { "JUL", "AGO", "SEP", "OCT", "NOV", "DIC" };
            }

            <div class="row mt-3">              
                <div class="col-md-6 border-end">
                    <div class="row text-center ">
                        @for (int i = 0; i < 6; i++)
                        {
                            <div class="col-2 p-1 glass-effect rounded">@mesesPrimerSemestre[i]</div>
                        }
                    </div>
                    <div class="row text-center">
                        @for (int i = 0; i < 6; i++)
                        {
                            <div class="col-2 p-1">
                                <input @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center mes-grupo1"
                                       value="@(Model.MesesServicios != null && Model.MesesServicios.Count > i ? Model.MesesServicios[i] : 0)" 
                                       min="0" data-mes="@mesesPrimerSemestre[i]">
                            </div>
                        }
                    </div>

                    <div class="row text-center mt-2">
                        @for (int i = 0; i < 6; i++)
                        {
                            <div class="col-2 p-1 glass-effect rounded">@mesesSegundoSemestre[i]</div>
                        }
                    </div>
                    <div class="row text-center">
                        @for (int i = 0; i < 6; i++)
                        {
                            var index = i + 6;
                            <div class="col-2 p-1">
                                <input @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center mes-grupo1"
                                       value="@(Model.MesesServicios != null && Model.MesesServicios.Count > index ? Model.MesesServicios[index] : 0)" 
                                       min="0" data-mes="@mesesSegundoSemestre[i]">
                            </div>
                        }
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="row text-center">
                        @for (int i = 0; i < 6; i++)
                        {
                            <div class="col-2 p-1 glass-effect rounded">@mesesPrimerSemestre[i]</div>
                        }
                    </div>
                    <div class="row text-center">
                        @for (int i = 0; i < 6; i++)
                        {
                            <div class="col-2 p-1">
                                <input @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center mes-grupo2"
                                       value="@(Model.MesesPersonas != null && Model.MesesPersonas.Count > i ? Model.MesesPersonas[i] : 0)" 
                                       min="0" data-mes="@mesesPrimerSemestre[i]">
                            </div>
                        }
                    </div>

                    <div class="row text-center mt-2">
                        @for (int i = 0; i < 6; i++)
                        {
                            <div class="col-2 p-1 glass-effect rounded">@mesesSegundoSemestre[i]</div>
                        }
                    </div>
                    <div class="row text-center">
                        @for (int i = 0; i < 6; i++)
                        {
                            var index = i + 6;
                            <div class="col-2 p-1">
                                <input @(!ViewBag.EsAdministrador ? "disabled" : "") type="number" class="input-arena form-control titulo text-center mes-grupo2"
                                       value="@(Model.MesesPersonas != null && Model.MesesPersonas.Count > index ? Model.MesesPersonas[index] : 0)" 
                                       min="0" data-mes="@mesesSegundoSemestre[i]">
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* Sección Valores y Resultados *@
        <div class="row mt-4 border-top pt-3">
            <div class="col-md-6 border-end pe-3">
                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-8">
                        <label class="mb-0 fw-semibold">Valor de servicios</label>
                    </div>
                    <div class="col-md-4">
                        <input class="input-arena form-control titulo text-center fw-bold"
                               id="valorServicios" value="@Model.TotalAnos" disabled>
                    </div>
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-8">
                        <label class="mb-0 fw-semibold">Valor de servicios por municipio</label>
                    </div>
                    <div class="col-md-4">
                        <input class="input-arena form-control titulo text-center"
                               id="valorServiciosMunicipio" value="0" disabled>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="mt-3" id="tablaGrupo1" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Personas Atendidas</th>
                                        <th>Municipio</th>
                                        <th>Región</th>
                                        <th>Número de región</th>
                                        <th>Clave del municipio</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyGrupo1"></tbody>
                                <tfoot>
                                    <tr class="fw-bold" style="background-color: #e9ecef;">
                                        <td id="totalGrupo1">0</td>
                                        <td colspan="5" class="text-end">Total Grupo Principal</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 ps-3">
                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-8">
                        <label class="mb-0 fw-semibold">Valor de personas</label>
                    </div>
                    <div class="col-md-4">
                        <input class="input-arena form-control titulo text-center fw-bold"
                               id="valorPersonas" value="@Model.TotalAnos2" disabled>
                    </div>
                </div>

                <div class="row align-items-center border-bottom py-2">
                    <div class="col-md-8">
                        <label class="mb-0 fw-semibold">Valor de personas por municipio</label>
                    </div>
                    <div class="col-md-4">
                        <input class="input-arena form-control titulo text-center"
                               id="valorPersonasMunicipio" value="0" disabled>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="mt-3" id="tablaGrupo2" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Personas Atendidas</th>
                                        <th>Municipio</th>
                                        <th>Región</th>
                                        <th>Número de región</th>
                                        <th>Clave del municipio</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyGrupo2"></tbody>
                                <tfoot>
                                    <tr class="fw-bold" style="background-color: #e9ecef;">
                                        <td id="totalGrupo2">0</td>
                                        <td colspan="5" class="text-end">Total Grupo Acumulable</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 

    @* Acciones necesarias *@
    <div class="border p-3 mb-4 rounded-4 shadow" id="accionesContainer">
        <div class="mb-2 text-center pb-1">
            <h5 class="pt-2 glass-effect rounded-5 mb-2 text-center border-bottom pb-3 fw-semibold titulo">
                ACCIONES NECESARIAS PARA REALIZAR LA ACTIVIDAD PRINCIPAL
            </h5>
        </div>

        <div id="accionesList">
            @if (Model.Acciones != null && Model.Acciones.Any())
            {
                foreach (var accion in Model.Acciones)
                {
                    <div class="border rounded p-3 mb-3 accion-item">
                        <div class="row align-items-center mb-3">
                            <div class="col-md-12">
                                <h6 class="fw-semibold mb-0 titulo">ACCIÓN</h6>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label fw-semibold small">DESCRIPCIÓN DE LA ACCIÓN</label>
                                <textarea class="form-control titulo input-arena" rows="3" @(!ViewBag.EsAdministrador ? "disabled" : "")>@accion.Descripcion</textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small">FRECUENCIA DE REALIZACIÓN</label>
                                <select class="form-control titulo input-arena" @(!ViewBag.EsAdministrador ? "disabled" : "")>
                                    <option value="">Seleccione la frecuencia</option>
                                    <option value="mensual" selected="@(accion.Frecuencia == "mensual")">MENSUAL</option>
                                    <option value="trimestral" selected="@(accion.Frecuencia == "trimestral")">TRIMESTRAL</option>
                                    <option value="anual" selected="@(accion.Frecuencia == "anual")">ANUAL</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-semibold small">FECHA INICIO</label>
                                <input type="date" class="form-control titulo input-arena fecha-inicio"
                                       value="@accion.FechaInicio?.ToString("yyyy-MM-dd")" @(!ViewBag.EsAdministrador ? "disabled" : "")>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted text-center">No hay acciones registradas</p>
            }
        </div>
    </div>

    @* Sección de Firmas *@
    <div class="p-3 mb-4 rounded-4 shadow">
        <div class="row p-3">
            <div class="col-md-4 text-center border-end">
                <label class="fw-semibold d-block mb-2">Elaboró</label>
                <input type="text" @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputElaboro" class="form-control text-center mb-2 input-arena" value="@Model.ElaboraNombre" />
                <input type="text" @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputElaboroCargo" class="form-control text-center input-arena" value="@Model.ElaboroCargo" />
            </div>

            <div class="col-md-4 text-center border-end">
                <label class="fw-semibold d-block mb-2">Revisó</label>
                <input type="text" @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputReviso" class="form-control text-center mb-2 input-arena" value="@Model.RevisionNombre" />
                <input type="text" @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputRevisoCargo" class="form-control text-center input-arena" value="@Model.RevisionCargo" />
            </div>

            <div class="col-md-4 text-center">
                <label class="fw-semibold d-block mb-2">Autorizó</label>
                <input type="text" @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputAutorizo" class="form-control text-center mb-2 input-arena" value="@Model.AutorizacionNombre" />
                <input type="text" @(!ViewBag.EsAdministrador ? "disabled" : "") id="inputAutorizoCargo" class="form-control text-center input-arena" value="@Model.AutorizacionCargo" />
            </div>
        </div>
    </div>

    @* BOTONES DE ACCIÓN *@
    @if (ViewBag.EsAdministrador)
    {
        <div class="text-center mb-5 mt-4">
            @if (Model.Estatus != 3)
            {
                <button class="btn btn-primary btn-lg me-3" id="btnGuardarAdmin">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
                <button class="btn btn-success btn-lg" id="btnValidarProgramacion" data-idprogramacion="@Model.Id">
                    <i class="fas fa-check-circle"></i> Validar Programación
                </button>
            }
        </div>
    }
    else
    {
        @if (Model.Estatus == 2)
        {
            <div class="text-center mb-5 mt-4">
                <button class="btn btn-success btn-lg" id="btnGuardarCambiosUsuario">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
            </div>
        }
    }

    @if (Model.Estatus == 3)
    {
        <div class="text-center mb-5 mt-4">
            <div class="alert alert-success" role="alert">
                <h4><i class="fas fa-check-circle"></i> Programación Validada</h4>
                <p class="mb-0">Esta programación ha sido aprobada y validada.</p>
            </div>
        </div>
    }

    @* Modal para comentarios *@
    <div class="modal fade" id="modalComentario" tabindex="-1" aria-labelledby="modalComentarioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalComentarioLabel">Agregar Comentario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="campoActual">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Campo:</label>
                        <p id="infoCampo" class="text-muted mb-3"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Comentario:</label>
                        <textarea class="form-control" id="textoComentario" rows="4" placeholder="Escribe tu comentario aquí..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="btnEliminarComentario" style="display: none;">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarComentario">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<input type="hidden" id="esAdministrador" value="@User.IsInRole("Administrador").ToString().ToLower()">
<input type="hidden" id="idProgramacionHidden" value="@ViewData["IdProgramacion"]">

@section Scripts {
    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let comentariosTemp = {};
        let modalComentario = null;

        const descripcionesCampos = {
            '4': 'PROGRAMA PRESUPUESTARIO', '5': 'NÚMERO DE COMPONENTE', '6': 'NÚMERO DE ACTIVIDAD',
            '7': 'JUSTIFICACIÓN', '8': 'DOCUMENTACIÓN SOPORTE', '9': 'ORIGEN DE RECURSOS',
            '10': 'PROGRAMA SOCIAL', '11': 'DESCRIPCIÓN ACTIVIDAD', '12': 'NOMBRE INDICADOR',
            '13': 'DEFINICIÓN INDICADOR', '14': 'CALENDARIZACIÓN', '15': 'UNIDAD DE MEDIDA',
            '16': 'MEDIOS VERIFICACIÓN', '17': 'SERIE INFORMACIÓN', '18': 'FUENTES INFORMACIÓN',
            '19': 'DELEGACIONES REGIONALES', '20': '¿DE QUÉ MANERA?', '21': 'AÑO (LÍNEA BASE)',
            '22': 'PORCENTAJE CUMPLIMIENTO', '23': 'BIEN/SERVICIO ENTREGADO', '24': 'PERSONAS ATENDIDAS',
            '25': 'AÑO (META)', '26': 'PORCENTAJE META', '27': 'BIEN/SERVICIO A ENTREGAR',
            '28': 'PERSONAS POR ATENDER', '29': 'BIEN O SERVICIO', '30': 'PERSONAS'
        };

        // ========================================
        // INICIALIZAR SISTEMA DE COMENTARIOS
        // ========================================
        function inicializarComentarios() {
            const inputAdmin = document.getElementById('esAdministrador');
            const esAdministrador = inputAdmin?.value?.toLowerCase() === 'true';

            // Inicializar modal
            const modalElement = document.getElementById('modalComentario');
            if (!modalElement || typeof bootstrap === 'undefined') return;

            try {
                modalComentario = new bootstrap.Modal(modalElement);
            } catch (error) {
                console.error('Error al inicializar modal:', error);
                return;
            }

            // Configurar botones de comentario
            const botonesComentario = document.querySelectorAll('.btn-comentario');
            botonesComentario.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const campo = this.getAttribute('data-campo');
                    const adminInput = document.getElementById('esAdministrador');
                    const esAdmin = adminInput?.value?.toLowerCase() === 'true';

                    if (esAdmin) {
                        abrirModalComentario(campo);
                    } else {
                        mostrarComentarioSoloLectura(campo);
                    }
                });
            });

            // Configurar botones del modal (solo admin)
            if (esAdministrador) {
                const btnGuardar = document.getElementById('btnGuardarComentario');
                const btnEliminar = document.getElementById('btnEliminarComentario');

                if (btnGuardar) btnGuardar.addEventListener('click', guardarComentarioIndividual);
                if (btnEliminar) btnEliminar.addEventListener('click', eliminarComentario);
            }

            // Cargar comentarios existentes
            cargarComentariosExistentes().then(() => {
                const adminCheck = document.getElementById('esAdministrador');
                const esAdmin = adminCheck?.value?.toLowerCase() === 'true';

                if (!esAdmin) {
                    setTimeout(bloquearCamposSinComentarios, 300);
                    setTimeout(configurarEventosEdicionCampos, 400);
                }
            });
        }

        // ========================================
        // MOSTRAR COMENTARIO SOLO LECTURA (USUARIOS)
        // ========================================
        function mostrarComentarioSoloLectura(campo) {
            const comentario = comentariosTemp[campo];

            if (!comentario || !comentario.texto || comentario.texto.trim() === '') {
                Swal.fire({
                    title: 'Sin comentarios',
                    text: `El campo ${campo}: ${descripcionesCampos[campo] || 'Desconocido'} no tiene comentarios.`,
                    icon: 'info',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            Swal.fire({
                title: `Comentario - Campo ${campo}`,
                html: `
                    <div class="text-start">
                        <p class="mb-2"><strong>${descripcionesCampos[campo] || 'Campo'}</strong></p>
                        <div class="alert alert-info">
                            <i class="fas fa-comment-dots"></i> ${comentario.texto}
                        </div>
                        <small class="text-muted">Este comentario fue agregado por el administrador. Puedes editar este campo y el comentario se eliminará automáticamente.</small>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#3085d6'
            });
        }

        // ========================================
        // BLOQUEAR CAMPOS SIN COMENTARIOS (USUARIOS)
        // ========================================
        function bloquearCamposSinComentarios() {
            // Bloquear TODOS los campos editables, EXCEPTO botones
            const todosLosCampos = document.querySelectorAll('input:not([type="hidden"]), select, textarea');

            todosLosCampos.forEach(campo => {
                if (campo.id === 'inputArea' || campo.id === 'inputDepartamento' || campo.id === 'inputAnoMeta') {
                    return;
                }
                if (campo.classList.contains('btn-comentario')) return;

                campo.disabled = true;
                campo.style.backgroundColor = '#f8f9fa';
                campo.style.cursor = 'not-allowed';
                campo.style.opacity = '0.7';
            });

            // Desbloquear solo los campos que tienen comentarios
            for (let campo = 4; campo <= 30; campo++) {
                const tieneComentario = comentariosTemp[campo]?.texto?.trim() !== '' && comentariosTemp[campo]?.texto !== undefined;

                if (tieneComentario) {
                    const elementosDelCampo = obtenerElementosPorCampo(campo);

                    elementosDelCampo.forEach(elemento => {
                        elemento.disabled = false;
                        elemento.style.backgroundColor = '';
                        elemento.style.cursor = '';
                        elemento.style.opacity = '';
                        elemento.title = 'Puedes editar este campo porque tiene comentarios del administrador.';
                        elemento.style.borderColor = '#28a745';
                        elemento.style.borderWidth = '2px';
                    });
                }
            }
        }

        // ========================================
        // OBTENER ELEMENTOS POR CAMPO
        // ========================================
        function obtenerElementosPorCampo(campo) {
            const elementos = [];

            const mapaCampos = {
                4: ['selectPrograma'],
                5: ['selectComponente'],
                6: ['inputActividad'],
                7: ['inputJustificacion'],
                8: ['inputDocumentacion'],
                9: ['selectFederal', 'selectEstatal'],
                10: ['inputPrograma'],
                11: ['inputDescripcion'],
                12: ['inputIndicador'],
                13: ['inputDefinicion'],
                14: ['primerServicio', 'segundoServicio', 'tercerServicio', 'cuartoServicio',
                     'primerPersona', 'segundoPersona', 'tercerPersona', 'cuartoPersona'],
                15: ['selectMedida'],
                16: ['inputMedios'],
                17: ['selectDesde', 'selectHasta'],
                18: ['inputFuentes'],
                19: ['selectDelegaciones'],
                20: ['inputDelegaciones'],
                21: ['selectAnoBase'],
                22: ['inputPorcentajeBase'],
                23: ['inputServicioBase'],
                24: ['inputPersonasBase'],
                25: ['inputAnoMeta'],
                26: ['inputPorcentajeMeta'],
                27: ['inputServicioMeta'],
                28: ['inputServicioMetas'],
                29: [],
                30: ['selectPersonas', 'selectAcumulable']
            };

            const ids = mapaCampos[campo] || [];

            ids.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elementos.push(elemento);
            });

            if (campo === 14) {
                document.querySelectorAll('.mes-grupo1, .mes-grupo2').forEach(input => {
                    elementos.push(input);
                });
            }

            if (campo === 29) {
                document.querySelectorAll('.mes-grupo1').forEach(input => {
                    elementos.push(input);
                });
            }

            return elementos;
        }

        // ========================================
        // CONFIGURAR EVENTOS EDICIÓN CAMPOS
        // ========================================
        function configurarEventosEdicionCampos() {
            for (let campo = 4; campo <= 30; campo++) {
                if (!comentariosTemp[campo]?.texto) continue;

                const elementosEditables = obtenerElementosPorCampo(campo);

                elementosEditables.forEach(elemento => {
                    if (elemento.disabled) return;

                    const valorOriginal = elemento.value;
                    elemento.setAttribute('data-valor-original', valorOriginal);

                    const eventoChange = function() {
                        const valorNuevo = this.value;
                        const valorOriginalGuardado = this.getAttribute('data-valor-original');

                        if (valorOriginalGuardado !== valorNuevo) {
                            borrarComentarioAlEditar(campo);

                            this.disabled = true;
                            this.style.backgroundColor = '#f8f9fa';
                            this.style.cursor = 'not-allowed';
                            this.style.opacity = '0.7';
                            this.style.borderColor = '';
                            this.style.borderWidth = '';
                        }
                    };

                    if (elemento.tagName === 'SELECT') {
                        elemento.addEventListener('change', eventoChange);
                    } else {
                        elemento.addEventListener('blur', eventoChange);
                    }
                });
            }
        }

        // ========================================
        // BORRAR COMENTARIO AL EDITAR
        // ========================================
        function borrarComentarioAlEditar(campo) {
            if (comentariosTemp[campo]) {
                delete comentariosTemp[campo];
                actualizarBotonComentario(campo, false);

                Swal.fire({
                    title: 'Comentario eliminado',
                    html: `El comentario del campo <strong>${campo}: ${descripcionesCampos[campo]}</strong> se eliminó porque editaste este campo.<br><br>
                           <small class="text-muted">Recuerda guardar los cambios cuando termines.</small>`,
                    icon: 'info',
                    timer: 4000,
                    showConfirmButton: true,
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // ========================================
        // ABRIR MODAL COMENTARIO (ADMIN)
        // ========================================
        function abrirModalComentario(campo) {
            const campoActual = document.getElementById('campoActual');
            const infoCampo = document.getElementById('infoCampo');
            const textoComentario = document.getElementById('textoComentario');
            const btnEliminar = document.getElementById('btnEliminarComentario');

            campoActual.value = campo;
            infoCampo.textContent = `Campo ${campo}: ${descripcionesCampos[campo] || 'Desconocido'}`;

            const comentarioExistente = comentariosTemp[campo];
            textoComentario.value = comentarioExistente?.texto || '';

            btnEliminar.style.display = comentarioExistente ? 'block' : 'none';

            modalComentario.show();
            setTimeout(() => textoComentario.focus(), 500);
        }

        // ========================================
        // GUARDAR COMENTARIO INDIVIDUAL
        // ========================================
        function guardarComentarioIndividual() {
            const campo = document.getElementById('campoActual').value;
            const texto = document.getElementById('textoComentario').value.trim();

            if (!texto) {
                Swal.fire('Error', 'El comentario no puede estar vacío', 'warning');
                return;
            }

            comentariosTemp[campo] = {
                texto: texto,
                fechaHora: new Date().toISOString()
            };

            actualizarBotonComentario(campo, true);
            modalComentario.hide();
            Swal.fire('Éxito', 'Comentario guardado temporalmente', 'success');
        }

        // ========================================
        // ELIMINAR COMENTARIO
        // ========================================
        function eliminarComentario() {
            const campo = document.getElementById('campoActual').value;

            delete comentariosTemp[campo];
            actualizarBotonComentario(campo, false);

            document.getElementById('textoComentario').value = '';
            modalComentario.hide();

            Swal.fire('Éxito', 'Comentario eliminado', 'success');
        }

        // ========================================
        // ACTUALIZAR BOTÓN COMENTARIO
        // ========================================
        function actualizarBotonComentario(campo, tieneComentario) {
            document.querySelectorAll(`button.btn-comentario[data-campo="${campo}"]`).forEach(btn => {
                if (tieneComentario) {
                    btn.className = 'btn btn-sm btn-comentario btn-comentario-con';
                    btn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                } else {
                    btn.className = 'btn btn-sm btn-comentario btn-comentario-sin';
                    btn.innerHTML = '<i class="fas fa-comment-medical"></i>';
                }
            });
        }

        // ========================================
        // CARGAR COMENTARIOS EXISTENTES
        // ========================================
        async function cargarComentariosExistentes() {
            try {
                const idProgramacion = document.getElementById('idProgramacionHidden').value;

                const response = await fetch(
                    `/Programacion/ObtenerComentariosPorProgramacion?idProgramacion=${idProgramacion}`
                );

                if (!response.ok) return;

                const comentarioObj = await response.json();

                for (let comentarioBD = 1; comentarioBD <= 27; comentarioBD++) {
                    const propiedad = `comentario${comentarioBD}`;
                    const texto = comentarioObj[propiedad];
                    const campoVista = comentarioBD + 3;

                    if (texto && texto.trim() !== '') {
                        comentariosTemp[campoVista] = { texto: texto };
                        actualizarBotonComentario(campoVista, true);
                    }
                }

            } catch (error) {
                console.error('Error cargando comentarios:', error);
            }
        }

        // ========================================
        // VALIDAR PROGRAMACIÓN
        // ========================================
        async function validarProgramacion() {
            const btn = document.getElementById('btnValidarProgramacion');
            const idProgramacion = btn.getAttribute('data-idprogramacion');

            const confirmacion = await Swal.fire({
                title: '¿Validar Programación?',
                text: 'Esta acción eliminará todos los comentarios y cambiará el estatus a "Validado". ¿Continuar?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, Validar',
                cancelButtonText: 'Cancelar'
            });

            if (!confirmacion.isConfirmed) return;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando...';

                const response = await fetch('/Programacion/ValidarProgramacion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ IdProgramacion: parseInt(idProgramacion) })
                });

                const resultado = await response.json();

                if (resultado.success) {
                    await Swal.fire({
                        title: '¡Validada!',
                        text: resultado.message,
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    });
                    window.location.href = '/Programacion/Programacion';
                } else {
                    throw new Error(resultado.message);
                }

            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });

                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Validar Programación';
            }
        }

        // ========================================
        // GUARDAR CAMBIOS ADMIN
        // ========================================
        async function guardarCambiosAdmin() {
            const btnGuardar = document.getElementById('btnGuardarAdmin');
            const textoOriginal = btnGuardar.innerHTML;
            const idProgramacion = document.getElementById('idProgramacionHidden')?.value;

            if (!idProgramacion) {
                await Swal.fire({ title: 'Error', text: 'No se encontró el ID de programación', icon: 'error' });
                return;
            }

            try {
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

                const obtenerValor = (id, valorDefault = '') => {
                    const elemento = document.getElementById(id);
                    return elemento ? elemento.value : valorDefault;
                };

                const obtenerTextoSelect = (id, valorDefault = '') => {
                    const elemento = document.getElementById(id);
                    if (!elemento) return valorDefault;
                    const opcionSeleccionada = elemento.selectedOptions[0];
                    return opcionSeleccionada ? opcionSeleccionada.text : valorDefault;
                };

                const obtenerValorNumerico = (id, valorDefault = 0) => {
                    const elemento = document.getElementById(id);
                    return elemento ? (parseInt(elemento.value) || valorDefault) : valorDefault;
                };

                const obtenerValorDecimal = (id, valorDefault = 0) => {
                    const elemento = document.getElementById(id);
                    return elemento ? (parseFloat(elemento.value) || valorDefault) : valorDefault;
                };

                // Preparar comentarios
                const comentariosArray = [];
                for (let campo = 4; campo <= 30; campo++) {
                    const comentarioBD = campo - 3;
                    const texto = comentariosTemp[campo]?.texto || '';
                    comentariosArray.push({
                        comentarioId: comentarioBD,
                        campo: campo,
                        texto: texto,
                        idProgramacion: parseInt(idProgramacion)
                    });
                }

                const datosCompletos = {
                    id: parseInt(idProgramacion),
                    area: obtenerValor('inputArea'),
                    departamento: obtenerValor('inputDepartamento'),
                    correoContacto: obtenerValor('inputCorreo'),
                    pp: obtenerValor('selectPrograma'),
                    nComponente: obtenerTextoSelect('selectComponente'),
                    componente: obtenerValorNumerico('selectComponente'),
                    nActividad: obtenerValorNumerico('inputActividad'),
                    justificacion: obtenerValor('inputJustificacion'),
                    descripcionDocumento: obtenerValor('inputDocumentacion'),
                    recursoFederal: obtenerValor('selectFederal'),
                    recursoEstatal: obtenerValor('selectEstatal'),
                    programaSocial: obtenerValor('inputPrograma'),
                    descripcionActividad: obtenerValor('inputDescripcion'),
                    nombreIndicador: obtenerValor('inputIndicador'),
                    definicionIndicador: obtenerValor('inputDefinicion'),
                    unidadMedida: obtenerTextoSelect('selectMedida'),
                    mediosVerificacion: obtenerValor('inputMedios'),
                    serieInformacionDesde: obtenerValor('selectDesde'),
                    serieInformacionHasta: obtenerValor('selectHasta'),
                    fuenteInformacion: obtenerValor('inputFuentes'),
                    intervienenDelegaciones: obtenerValor('selectDelegaciones'),
                    intervienenDelegacionesManera: obtenerValor('inputDelegaciones'),
                    anoBase: obtenerValorNumerico('selectAnoBase'),
                    porcentajeBase: obtenerValorDecimal('inputPorcentajeBase'),
                    servicioBase: obtenerValorNumerico('inputServicioBase'),
                    personasBase: obtenerValorNumerico('inputPersonasBase'),
                    anoMeta: obtenerValorNumerico('inputAnoMeta'),
                    porcentajeMeta: obtenerValorDecimal('inputPorcentajeMeta'),
                    servicioMeta: obtenerValorNumerico('inputServicioMeta'),
                    personasMeta: obtenerValorNumerico('inputServicioMetas'),
                    primerServicio: obtenerValorNumerico('primerServicio'),
                    segundoServicio: obtenerValorNumerico('segundoServicio'),
                    tercerServicio: obtenerValorNumerico('tercerServicio'),
                    cuartoServicio: obtenerValorNumerico('cuartoServicio'),
                    primerPersona: obtenerValorNumerico('primerPersona'),
                    segundoPersona: obtenerValorNumerico('segundoPersona'),
                    tercerPersona: obtenerValorNumerico('tercerPersona'),
                    cuartoPersona: obtenerValorNumerico('cuartoPersona'),
                    selectAcumulable: obtenerValor('selectAcumulable'),
                    beneficiarios: obtenerValor('selectPersonas'),
                    totalAnos: obtenerValorNumerico('valorServicios'),
                    totalAnos2: obtenerValorNumerico('valorPersonas'),
                    elaboraNombre: obtenerValor('inputElaboro'),
                    elaboroCargo: obtenerValor('inputElaboroCargo'),
                    revisionNombre: obtenerValor('inputReviso'),
                    revisionCargo: obtenerValor('inputRevisoCargo'),
                    autorizacionNombre: obtenerValor('inputAutorizo'),
                    autorizacionCargo: obtenerValor('inputAutorizoCargo'),
                    mesesServicios: [],
                    mesesPersonas: [],
                    municipiosServicios: [],
                    municipiosPersonas: [],
                    acciones: [],
                    comentarios: comentariosArray
                };

                // Meses
                document.querySelectorAll('.mes-grupo1').forEach(input => {
                    datosCompletos.mesesServicios.push(parseInt(input.value) || 0);
                });
                document.querySelectorAll('.mes-grupo2').forEach(input => {
                    datosCompletos.mesesPersonas.push(parseInt(input.value) || 0);
                });

                // Municipios
                document.querySelectorAll('#tbodyGrupo1 tr').forEach(fila => {
                    const idMunicipio = parseInt(fila.getAttribute('data-id-municipio')) || 0;
                    const cantidad = parseInt(fila.getAttribute('data-cantidad')) || 0;
                    if (idMunicipio > 0 && cantidad > 0) {
                        datosCompletos.municipiosServicios.push({ idMunicipio, cantidad });
                    }
                });
                document.querySelectorAll('#tbodyGrupo2 tr').forEach(fila => {
                    const idMunicipio = parseInt(fila.getAttribute('data-id-municipio')) || 0;
                    const cantidad = parseInt(fila.getAttribute('data-cantidad')) || 0;
                    if (idMunicipio > 0 && cantidad > 0) {
                        datosCompletos.municipiosPersonas.push({ idMunicipio, cantidad });
                    }
                });

                // Acciones
                document.querySelectorAll('.accion-item').forEach(accion => {
                    const descripcion = accion.querySelector('textarea')?.value || '';
                    const frecuencia = accion.querySelector('select')?.value || '';
                    const fechaStr = accion.querySelector('.fecha-inicio')?.value || '';
                    if (descripcion.trim() !== '') {
                        datosCompletos.acciones.push({
                            descripcion,
                            frecuencia,
                            fechaInicio: fechaStr || null
                        });
                    }
                });

                const response = await fetch('/Programacion/GuardarCambiosAdmin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosCompletos)
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

                const resultado = await response.json();

                if (resultado.success) {
                    await Swal.fire({
                        title: '¡Éxito!',
                        text: resultado.message,
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    });
                    window.location.href = '/Programacion/Programacion';
                } else {
                    throw new Error(resultado.message || 'Error al guardar');
                }

            } catch (error) {
                console.error('Error al guardar:', error);
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = textoOriginal;

                await Swal.fire({
                    title: 'Error',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            }
        }

        // ========================================
        // GUARDAR CAMBIOS USUARIO
        // ========================================
        async function guardarCambiosUsuario() {
            const btnGuardar = document.getElementById('btnGuardarCambiosUsuario');
            const textoOriginal = btnGuardar.innerHTML;
            const idProgramacion = document.getElementById('idProgramacionHidden')?.value;

            if (!idProgramacion) {
                await Swal.fire({ title: 'Error', text: 'No se encontró el ID de programación', icon: 'error' });
                return;
            }

            try {
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

                const obtenerValor = (id, valorDefault = '') => {
                    const elemento = document.getElementById(id);
                    return elemento ? elemento.value : valorDefault;
                };

                const obtenerTextoSelect = (id, valorDefault = '') => {
                    const elemento = document.getElementById(id);
                    if (!elemento) return valorDefault;
                    const opcionSeleccionada = elemento.selectedOptions[0];
                    return opcionSeleccionada ? opcionSeleccionada.text : valorDefault;
                };

                const obtenerValorNumerico = (id, valorDefault = 0) => {
                    const elemento = document.getElementById(id);
                    return elemento ? (parseInt(elemento.value) || valorDefault) : valorDefault;
                };

                const obtenerValorDecimal = (id, valorDefault = 0) => {
                    const elemento = document.getElementById(id);
                    return elemento ? (parseFloat(elemento.value) || valorDefault) : valorDefault;
                };

                // Preparar comentarios restantes
                const comentariosRestantes = [];
                for (let campo = 4; campo <= 30; campo++) {
                    const comentarioBD = campo - 3;
                    const texto = comentariosTemp[campo]?.texto || '';
                    comentariosRestantes.push({
                        comentarioId: comentarioBD,
                        campo: campo,
                        texto: texto,
                        idProgramacion: parseInt(idProgramacion)
                    });
                }

                const datosCompletos = {
                    id: parseInt(idProgramacion),
                    area: obtenerValor('inputArea'),
                    departamento: obtenerValor('inputDepartamento'),
                    correoContacto: obtenerValor('inputCorreo'),
                    pp: obtenerValor('selectPrograma'),
                    nComponente: obtenerTextoSelect('selectComponente'),
                    componente: obtenerValorNumerico('selectComponente'),
                    nActividad: obtenerValorNumerico('inputActividad'),
                    justificacion: obtenerValor('inputJustificacion'),
                    descripcionDocumento: obtenerValor('inputDocumentacion'),
                    recursoFederal: obtenerValor('selectFederal'),
                    recursoEstatal: obtenerValor('selectEstatal'),
                    programaSocial: obtenerValor('inputPrograma'),
                    descripcionActividad: obtenerValor('inputDescripcion'),
                    nombreIndicador: obtenerValor('inputIndicador'),
                    definicionIndicador: obtenerValor('inputDefinicion'),
                    unidadMedida: obtenerTextoSelect('selectMedida'),
                    mediosVerificacion: obtenerValor('inputMedios'),
                    serieInformacionDesde: obtenerValor('selectDesde'),
                    serieInformacionHasta: obtenerValor('selectHasta'),
                    fuenteInformacion: obtenerValor('inputFuentes'),
                    intervienenDelegaciones: obtenerValor('selectDelegaciones'),
                    intervienenDelegacionesManera: obtenerValor('inputDelegaciones'),
                    anoBase: obtenerValorNumerico('selectAnoBase'),
                    porcentajeBase: obtenerValorDecimal('inputPorcentajeBase'),
                    servicioBase: obtenerValorNumerico('inputServicioBase'),
                    personasBase: obtenerValorNumerico('inputPersonasBase'),
                    anoMeta: obtenerValorNumerico('inputAnoMeta'),
                    porcentajeMeta: obtenerValorDecimal('inputPorcentajeMeta'),
                    servicioMeta: obtenerValorNumerico('inputServicioMeta'),
                    personasMeta: obtenerValorNumerico('inputServicioMetas'),
                    primerServicio: obtenerValorNumerico('primerServicio'),
                    segundoServicio: obtenerValorNumerico('segundoServicio'),
                    tercerServicio: obtenerValorNumerico('tercerServicio'),
                    cuartoServicio: obtenerValorNumerico('cuartoServicio'),
                    primerPersona: obtenerValorNumerico('primerPersona'),
                    segundoPersona: obtenerValorNumerico('segundoPersona'),
                    tercerPersona: obtenerValorNumerico('tercerPersona'),
                    cuartoPersona: obtenerValorNumerico('cuartoPersona'),
                    selectAcumulable: obtenerValor('selectAcumulable'),
                    beneficiarios: obtenerValor('selectPersonas'),
                    totalAnos: obtenerValorNumerico('valorServicios'),
                    totalAnos2: obtenerValorNumerico('valorPersonas'),
                    elaboraNombre: obtenerValor('inputElaboro'),
                    elaboroCargo: obtenerValor('inputElaboroCargo'),
                    revisionNombre: obtenerValor('inputReviso'),
                    revisionCargo: obtenerValor('inputRevisoCargo'),
                    autorizacionNombre: obtenerValor('inputAutorizo'),
                    autorizacionCargo: obtenerValor('inputAutorizoCargo'),
                    mesesServicios: [],
                    mesesPersonas: [],
                    municipiosServicios: [],
                    municipiosPersonas: [],
                    acciones: [],
                    comentarios: comentariosRestantes
                };

                // Meses
                document.querySelectorAll('.mes-grupo1').forEach(input => {
                    datosCompletos.mesesServicios.push(parseInt(input.value) || 0);
                });
                document.querySelectorAll('.mes-grupo2').forEach(input => {
                    datosCompletos.mesesPersonas.push(parseInt(input.value) || 0);
                });

                // Municipios
                document.querySelectorAll('#tbodyGrupo1 tr').forEach(fila => {
                    const idMunicipio = parseInt(fila.getAttribute('data-id-municipio')) || 0;
                    const cantidad = parseInt(fila.getAttribute('data-cantidad')) || 0;
                    if (idMunicipio > 0 && cantidad > 0) {
                        datosCompletos.municipiosServicios.push({ idMunicipio, cantidad });
                    }
                });
                document.querySelectorAll('#tbodyGrupo2 tr').forEach(fila => {
                    const idMunicipio = parseInt(fila.getAttribute('data-id-municipio')) || 0;
                    const cantidad = parseInt(fila.getAttribute('data-cantidad')) || 0;
                    if (idMunicipio > 0 && cantidad > 0) {
                        datosCompletos.municipiosPersonas.push({ idMunicipio, cantidad });
                    }
                });

                // Acciones
                document.querySelectorAll('.accion-item').forEach(accion => {
                    const descripcion = accion.querySelector('textarea')?.value || '';
                    const frecuencia = accion.querySelector('select')?.value || '';
                    const fechaStr = accion.querySelector('.fecha-inicio')?.value || '';
                    if (descripcion.trim() !== '') {
                        datosCompletos.acciones.push({ descripcion, frecuencia, fechaInicio: fechaStr || null });
                    }
                });

                const response = await fetch('/Programacion/GuardarCambiosUsuario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosCompletos)
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

                const resultado = await response.json();

                if (resultado.success) {
                    await Swal.fire({
                        title: '¡Éxito!',
                        text: 'Cambios guardados correctamente. La programación fue enviada a revisión.',
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    });
                    window.location.href = '/Programacion/Programacion';
                } else {
                    throw new Error(resultado.message || 'Error al guardar');
                }

            } catch (error) {
                console.error('Error al guardar:', error);
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = textoOriginal;

                await Swal.fire({
                    title: 'Error',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            }
        }

        // ========================================
        // CONFIGURAR SELECT PROGRAMA-COMPONENTE
        // ========================================
        function configurarSelectProgramaComponente() {
            const $selectPrograma = $('#selectPrograma');
            const $selectComponente = $('#selectComponente');

            if (!$selectPrograma.length || !$selectComponente.length) return;

            const componenteSeleccionadoOriginal = $selectComponente.val();
            const componenteTextoOriginal = $selectComponente.find('option:selected').text();
            const todasOpciones = $selectComponente.find('option:not(:first)').clone();
            const programaSeleccionadoInicial = $selectPrograma.find('option:selected').text();

            filtrarComponentes(programaSeleccionadoInicial, componenteSeleccionadoOriginal);

            $selectPrograma.on('change', function() {
                const programaSeleccionado = $(this).find('option:selected').text();
                filtrarComponentes(programaSeleccionado, null);
            });

            function filtrarComponentes(programaTexto, componenteASeleccionar) {
                $selectComponente.find('option:not(:first)').remove();

                if (programaTexto && programaTexto.trim() !== '' && programaTexto !== 'Seleccione Programa') {
                    todasOpciones.each(function() {
                        const opcionPrograma = $(this).data('programa');
                        if (opcionPrograma === programaTexto) {
                            $selectComponente.append($(this).clone());
                        }
                    });

                    $selectComponente.prop('disabled', false);

                    if (componenteASeleccionar) {
                        $selectComponente.val(componenteASeleccionar);
                        if ($selectComponente.val() !== componenteASeleccionar) {
                            $selectComponente.find('option').each(function() {
                                if ($(this).text() === componenteTextoOriginal) {
                                    $(this).prop('selected', true);
                                }
                            });
                        }
                    }
                } else {
                    $selectComponente.prop('disabled', true);
                }
            }
        }

        // ========================================
        // CALCULAR SUMATORIAS
        // ========================================
        function calcularSumatorias() {
            const selectAcumulable = document.getElementById('selectAcumulable');
            let sumaGrupo1 = 0;
            let sumaGrupo2 = 0;

            document.querySelectorAll('.mes-grupo1').forEach(input => {
                sumaGrupo1 += parseInt(input.value) || 0;
            });

            if (selectAcumulable && selectAcumulable.value === 'si') {
                document.querySelectorAll('.mes-grupo2').forEach(input => {
                    sumaGrupo2 += parseInt(input.value) || 0;
                });
            }

            const valorServiciosEl = document.getElementById('valorServicios');
            const valorPersonasEl = document.getElementById('valorPersonas');

            if (valorServiciosEl) valorServiciosEl.value = sumaGrupo1;
            if (valorPersonasEl) valorPersonasEl.value = sumaGrupo2;

            calcularTrimestres();
        }

        // ========================================
        // CALCULAR TRIMESTRES
        // ========================================
        function calcularTrimestres() {
            const trimestres = {
                1: ['ENE', 'FEB', 'MAR'],
                2: ['ABR', 'MAY', 'JUN'],
                3: ['JUL', 'AGO', 'SEP'],
                4: ['OCT', 'NOV', 'DIC']
            };

            const camposServicios = { 1: 'primerServicio', 2: 'segundoServicio', 3: 'tercerServicio', 4: 'cuartoServicio' };
            const camposPersonas = { 1: 'primerPersona', 2: 'segundoPersona', 3: 'tercerPersona', 4: 'cuartoPersona' };

            for (let i = 1; i <= 4; i++) {
                let sumaServicios = 0;
                let sumaPersonas = 0;

                trimestres[i].forEach(mes => {
                    const inputServicio = document.querySelector(`.mes-grupo1[data-mes="${mes}"]`);
                    const inputPersona = document.querySelector(`.mes-grupo2[data-mes="${mes}"]`);

                    if (inputServicio) sumaServicios += parseInt(inputServicio.value) || 0;
                    if (inputPersona) sumaPersonas += parseInt(inputPersona.value) || 0;
                });

                const campoServicio = document.getElementById(camposServicios[i]);
                const campoPersona = document.getElementById(camposPersonas[i]);

                if (campoServicio) campoServicio.value = sumaServicios;
                if (campoPersona) campoPersona.value = sumaPersonas;
            }
        }

        // ========================================
        // INICIALIZACIÓN PRINCIPAL
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            inicializarComentarios();
            configurarSelectProgramaComponente();

            // Eventos de cálculo para admin
            document.querySelectorAll('.mes-grupo1, .mes-grupo2').forEach(input => {
                if (!input.disabled) {
                    input.addEventListener('input', calcularSumatorias);
                }
            });

            // Botón guardar admin
            const btnGuardarAdmin = document.getElementById('btnGuardarAdmin');
            if (btnGuardarAdmin) {
                btnGuardarAdmin.addEventListener('click', guardarCambiosAdmin);
            }

            // Botón validar
            const btnValidar = document.getElementById('btnValidarProgramacion');
            if (btnValidar) {
                btnValidar.addEventListener('click', validarProgramacion);
            }

            // Botón guardar usuario
            const btnGuardarUsuario = document.getElementById('btnGuardarCambiosUsuario');
            if (btnGuardarUsuario) {
                btnGuardarUsuario.addEventListener('click', guardarCambiosUsuario);
            }

            calcularSumatorias();
        });

    </script>
}
